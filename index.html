<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¾²å ´ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        .fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .feature-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .calendar-day {
            min-height: 120px;
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
            background-color: #f8fafc;
            transform: scale(1.02);
        }
        
        .work-type-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin: 1px;
            display: inline-block;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .work-type-badge:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Main Cover Page -->
    <div id="coverPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-6xl w-full">
            <!-- Header -->
            <div class="text-center mb-12 fade-in">
                <div class="text-8xl mb-6">ğŸŠ</div>
                <h1 class="text-5xl md:text-6xl font-bold text-white mb-4">è¾²å ´ç®¡ç†ç³»çµ±</h1>
                <p class="text-xl text-white/80 max-w-2xl mx-auto">
                    å°ˆæ¥­çš„è¾²å ´ä½œæ¥­è¨˜éŒ„èˆ‡è³‡æç®¡ç†å¹³å°ï¼Œè®“æ‚¨çš„è¾²å ´ç®¡ç†æ›´åŠ é«˜æ•ˆä¾¿åˆ©
                </p>
            </div>

            <!-- Navigation Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 fade-in">
                <!-- æ–°å¢å·¥ä½œæ—¥èªŒ -->
                <div class="feature-card rounded-2xl p-8 text-center card-hover cursor-pointer" onclick="showSection('workLog')">
                    <div class="text-5xl mb-4">ğŸ“</div>
                    <h3 class="text-xl font-semibold text-white mb-3">æ–°å¢å·¥ä½œæ—¥èªŒ</h3>
                    <p class="text-white/70 text-sm mb-4">è¨˜éŒ„æ¯æ—¥è¾²å ´ä½œæ¥­å…§å®¹ã€å¤©æ°£ç‹€æ³åŠè§€å¯Ÿå¿ƒå¾—</p>
                    <div class="bg-white/20 hover:bg-white/30 transition-colors rounded-lg py-2 px-4 text-white font-medium">
                        é–‹å§‹è¨˜éŒ„ â†’
                    </div>
                </div>

                <!-- æ–°å¢è³‡æåŠäººå“¡ -->
                <div class="feature-card rounded-2xl p-8 text-center card-hover cursor-pointer" onclick="showSection('addResources')">
                    <div class="text-5xl mb-4">â•</div>
                    <h3 class="text-xl font-semibold text-white mb-3">æ–°å¢è³‡æåŠäººå“¡</h3>
                    <p class="text-white/70 text-sm mb-4">å»ºç«‹è³‡æåº«å­˜æ¸…å–®èˆ‡äººå“¡è³‡æ–™åº«</p>
                    <div class="bg-white/20 hover:bg-white/30 transition-colors rounded-lg py-2 px-4 text-white font-medium">
                        æ–°å¢è³‡æ–™ â†’
                    </div>
                </div>

                <!-- äººå“¡è³‡æç®¡ç† -->
                <div class="feature-card rounded-2xl p-8 text-center card-hover cursor-pointer" onclick="showSection('management')">
                    <div class="text-5xl mb-4">ğŸ‘¥</div>
                    <h3 class="text-xl font-semibold text-white mb-3">äººå“¡è³‡æç®¡ç†</h3>
                    <p class="text-white/70 text-sm mb-4">ç®¡ç†è¾²å ´äººå“¡è³‡è¨Šèˆ‡è³‡æåº«å­˜ç‹€æ³</p>
                    <div class="bg-white/20 hover:bg-white/30 transition-colors rounded-lg py-2 px-4 text-white font-medium">
                        é€²å…¥ç®¡ç† â†’
                    </div>
                </div>

                <!-- æ‰€æœ‰å·¥ä½œæ—¥èªŒ -->
                <div class="feature-card rounded-2xl p-8 text-center card-hover cursor-pointer" onclick="showSection('allLogs')">
                    <div class="text-5xl mb-4">ğŸ“Š</div>
                    <h3 class="text-xl font-semibold text-white mb-3">æ‰€æœ‰å·¥ä½œæ—¥èªŒ</h3>
                    <p class="text-white/70 text-sm mb-4">æŸ¥çœ‹æ­·å²è¨˜éŒ„èˆ‡çµ±è¨ˆåˆ†æ</p>
                    <div class="bg-white/20 hover:bg-white/30 transition-colors rounded-lg py-2 px-4 text-white font-medium">
                        æŸ¥çœ‹è¨˜éŒ„ â†’
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6 fade-in">
                <div class="feature-card rounded-xl p-6 text-center">
                    <div class="text-3xl text-white font-bold" id="totalLogs">0</div>
                    <div class="text-white/70">ç¸½å·¥ä½œè¨˜éŒ„</div>
                </div>
                <div class="feature-card rounded-xl p-6 text-center">
                    <div class="text-3xl text-white font-bold" id="totalMaterials">0</div>
                    <div class="text-white/70">è³‡æç¨®é¡</div>
                </div>
                <div class="feature-card rounded-xl p-6 text-center">
                    <div class="text-3xl text-white font-bold" id="totalPersonnel">0</div>
                    <div class="text-white/70">äººå“¡æ•¸é‡</div>
                </div>
            </div>

            <!-- Data Management -->
            <div class="mt-8 flex justify-center space-x-4 fade-in">
                <button onclick="exportData()" class="feature-card rounded-lg px-6 py-3 text-white hover:bg-white/10 transition-colors flex items-center">
                    <span class="mr-2">ğŸ“¤</span>åŒ¯å‡ºè³‡æ–™
                </button>
                <label class="feature-card rounded-lg px-6 py-3 text-white hover:bg-white/10 transition-colors flex items-center cursor-pointer">
                    <span class="mr-2">ğŸ“¥</span>åŒ¯å…¥è³‡æ–™
                    <input type="file" id="importFile" accept=".csv" class="hidden" onchange="importData(event)">
                </label>
            </div>
        </div>
    </div>

    <!-- Work Log Section -->
    <div id="workLogSection" class="hidden min-h-screen bg-gradient-to-br from-green-50 to-blue-50">
        <div class="container mx-auto px-4 py-8 max-w-6xl">
            <!-- Back Button -->
            <button onclick="showSection('cover')" class="mb-6 bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg shadow-md transition-colors flex items-center">
                â† è¿”å›é¦–é 
            </button>

            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ“ æ–°å¢å·¥ä½œæ—¥èªŒ</h1>
                <p class="text-gray-600">è¨˜éŒ„æ‚¨çš„è¾²å ´æ—¥å¸¸ä½œæ¥­èˆ‡è§€å¯Ÿ</p>
            </div>

            <!-- Work Log Form -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border border-gray-100">
                <form id="farmLogForm" class="space-y-6">
                    <!-- Basic Information Row -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ—¥æœŸ</label>
                            <input type="date" id="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">åœ°é»</label>
                            <input type="text" id="location" placeholder="ä¾‹ï¼šAå€ç”°åœ°" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å¤©æ°£</label>
                            <select id="weather" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                                <option value="">é¸æ“‡å¤©æ°£</option>
                                <option value="æ™´å¤©">â˜€ï¸ æ™´å¤©</option>
                                <option value="å¤šé›²">â›… å¤šé›²</option>
                                <option value="é™°å¤©">â˜ï¸ é™°å¤©</option>
                                <option value="å°é›¨">ğŸŒ¦ï¸ å°é›¨</option>
                                <option value="å¤§é›¨">ğŸŒ§ï¸ å¤§é›¨</option>
                            </select>
                        </div>
                    </div>

                    <!-- Work Details Row -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ä½œæ¥­é¡å‹</label>
                            <select id="workType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                                <option value="">é¸æ“‡ä½œæ¥­é¡å‹</option>
                                <option value="æ•´åœ°">ğŸšœ æ•´åœ°</option>
                                <option value="æ’­ç¨®/è‚²è‹—">ğŸŒ± æ’­ç¨®/è‚²è‹—</option>
                                <option value="æ–½è‚¥">ğŸŒ¿ æ–½è‚¥</option>
                                <option value="çŒæº‰">ğŸ’§ çŒæº‰</option>
                                <option value="ç—…èŸ²å®³é˜²æ²»">ğŸ› ç—…èŸ²å®³é˜²æ²»</option>
                                <option value="é™¤è‰">ğŸŒ¾ é™¤è‰</option>
                                <option value="ä¿®å‰ª/ç–æœ">âœ‚ï¸ ä¿®å‰ª/ç–æœ</option>
                                <option value="æ¡æ”¶">ğŸ¥• æ¡æ”¶</option>
                                <option value="ç¶­è­·">ğŸ”§ ç¶­è­·</option>
                                <option value="å…¶ä»–">ğŸ“‹ å…¶ä»–</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ä½œç‰©</label>
                            <input type="text" id="crop" placeholder="ä¾‹ï¼šç•ªèŒ„ã€ç‰ç±³" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        </div>
                    </div>

                    <!-- Material Usage Section -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">ğŸ§ª</span>è³‡æä½¿ç”¨
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700 mb-2">è³‡æåç¨±</label>
                                <input type="text" id="materialName" placeholder="è¼¸å…¥é—œéµå­—æœå°‹è³‡æ..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                <div id="materialSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-40 overflow-y-auto"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ä½¿ç”¨é‡</label>
                                <input type="number" id="materialQuantity" placeholder="æ•¸é‡" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">å–®ä½</label>
                                <select id="materialUnit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                    <option value="æ¯«å‡">æ¯«å‡</option>
                                    <option value="å…¬å‡">å…¬å‡</option>
                                    <option value="å…‹">å…‹</option>
                                    <option value="å…¬æ–¤">å…¬æ–¤</option>
                                    <option value="æ–¤">æ–¤</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ç¨€é‡‹å€æ•¸</label>
                                <input type="number" id="dilutionRatio" placeholder="ä¾‹ï¼š100" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 mb-4">
                            <button type="button" id="addMaterialBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                                <span class="mr-1">â•</span>æ·»åŠ è³‡æ
                            </button>
                            <div id="materialTotal" class="bg-blue-100 text-blue-800 px-3 py-2 rounded-lg text-sm hidden">
                                ç¸½ç”¨é‡ï¼š<span id="totalAmount"></span>
                            </div>
                        </div>
                        
                        <div id="materialsList" class="space-y-2"></div>
                    </div>

                    <!-- Work Personnel Section -->
                    <div class="bg-gray-50 rounded-lg p-4 mt-6">
                        <h3 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">ğŸ‘¥</span>å·¥ä½œäººå“¡åŠå·¥æ™‚
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700 mb-2">äººå“¡å§“å</label>
                                <input type="text" id="workerName" placeholder="è¼¸å…¥é—œéµå­—æœå°‹äººå“¡..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                                <div id="workerSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-40 overflow-y-auto"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">å·¥ä½œæ™‚æ•¸</label>
                                <input type="number" id="workHours" placeholder="å°æ™‚" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                            </div>
                            <div class="flex items-end">
                                <button type="button" id="addWorkerBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center w-full justify-center">
                                    <span class="mr-1">â•</span>æ·»åŠ äººå“¡
                                </button>
                            </div>
                        </div>
                        
                        <div id="workersList" class="space-y-2"></div>
                    </div>

                    <!-- Details and Observations -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ä½œæ¥­è©³æƒ…</label>
                            <textarea id="details" rows="3" placeholder="è©³ç´°æè¿°ä½œæ¥­å…§å®¹..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all resize-none"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ç”¢é‡è¨˜éŒ„</label>
                            <input type="text" id="yield" placeholder="ä¾‹ï¼šæ”¶ç©« 50 å…¬æ–¤ç•ªèŒ„" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">è§€å¯Ÿè¨˜éŒ„</label>
                            <textarea id="observations" rows="3" placeholder="è¨˜éŒ„ä½œç‰©ç”Ÿé•·ç‹€æ³ã€ç—…èŸ²å®³ç­‰..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all resize-none"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label>
                            <textarea id="notes" rows="3" placeholder="å…¶ä»–éœ€è¦è¨˜éŒ„çš„äº‹é …..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all resize-none"></textarea>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex justify-end">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-medium transition-colors flex items-center shadow-lg">
                            <span class="mr-2">ğŸ’¾</span>å„²å­˜è¨˜éŒ„
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Resources Section -->
    <div id="addResourcesSection" class="hidden min-h-screen bg-gradient-to-br from-purple-50 to-pink-50">
        <div class="container mx-auto px-4 py-8 max-w-4xl">
            <button onclick="showSection('cover')" class="mb-6 bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg shadow-md transition-colors flex items-center">
                â† è¿”å›é¦–é 
            </button>

            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">â• æ–°å¢è³‡æåŠäººå“¡</h1>
                <p class="text-gray-600">å»ºç«‹æ‚¨çš„è³‡æåº«å­˜èˆ‡äººå“¡è³‡æ–™åº«</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Add Material -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">ğŸ§ª</span>æ–°å¢è³‡æ
                    </h2>
                    <form id="addMaterialForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">è³‡æåç¨±</label>
                            <input type="text" id="newMaterialName" placeholder="ä¾‹ï¼šæœ‰æ©Ÿè‚¥æ–™" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é¡åˆ¥</label>
                            <select id="materialCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                                <option value="è‚¥æ–™">è‚¥æ–™</option>
                                <option value="è¾²è—¥">è¾²è—¥</option>
                                <option value="ç¨®å­">ç¨®å­</option>
                                <option value="å·¥å…·">å·¥å…·</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å…¥åº«æ—¥æœŸ</label>
                            <input type="date" id="stockDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                        </div>
                        
                        <!-- åº«å­˜ç®¡ç†å€å¡Š -->
                        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                            <h4 class="text-sm font-medium text-blue-800 mb-3 flex items-center">
                                <span class="mr-2">ğŸ“¦</span>åº«å­˜ç®¡ç†
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">å…¥åº«æ•¸é‡</label>
                                    <input type="number" id="initialStock" placeholder="0" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" oninput="calculateUnitPrice()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">åº«å­˜å–®ä½</label>
                                    <select id="stockUnit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" onchange="toggleBottleCapacity()">
                                        <option value="æ¯«å‡">æ¯«å‡</option>
                                        <option value="å…¬å‡">å…¬å‡</option>
                                        <option value="å…‹">å…‹</option>
                                        <option value="å…¬æ–¤">å…¬æ–¤</option>
                                        <option value="æ–¤">æ–¤</option>
                                        <option value="åŒ…">åŒ…</option>
                                        <option value="ç“¶">ç“¶</option>
                                        <option value="è¢‹">è¢‹</option>
                                        <option value="å€‹">å€‹</option>
                                    </select>
                                </div>
                                <div id="bottleCapacityDiv" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">æ¯ç“¶å®¹é‡</label>
                                    <div class="flex space-x-2">
                                        <input type="number" id="bottleCapacity" placeholder="å®¹é‡" step="0.1" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                                        <select id="bottleCapacityUnit" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                                            <option value="æ¯«å‡">æ¯«å‡</option>
                                            <option value="å…¬å‡">å…¬å‡</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">å…¥åº«åƒ¹éŒ¢</label>
                                    <input type="number" id="totalPrice" placeholder="ç¸½åƒ¹æ ¼" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" oninput="calculateUnitPrice()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">å–®åƒ¹ (è‡ªå‹•è¨ˆç®—)</label>
                                    <input type="number" id="unitPrice" placeholder="æ¯å–®ä½åƒ¹æ ¼ (å…ƒ)" step="0.1" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label>
                            <input type="text" id="materialRemarks" placeholder="ä¾‹ï¼šä½¿ç”¨æ–¹æ³•ã€æ³¨æ„äº‹é …" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                        </div>

                        <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg transition-colors">
                            æ–°å¢è³‡æ
                        </button>
                    </form>
                </div>

                <!-- Add Personnel -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">ğŸ‘¤</span>æ–°å¢äººå“¡
                    </h2>
                    <form id="addPersonnelForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å§“å</label>
                            <input type="text" id="personnelName" placeholder="å“¡å·¥å§“å" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">è·ä½</label>
                            <select id="personnelRole" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                <option value="è¾²å ´ä¸»">è¾²å ´ä¸»</option>
                                <option value="è¾²å ´ç¶“ç†">è¾²å ´ç¶“ç†</option>
                                <option value="æŠ€è¡“å“¡">æŠ€è¡“å“¡</option>
                                <option value="å·¥äºº">å·¥äºº</option>
                                <option value="è‡¨æ™‚å·¥">è‡¨æ™‚å·¥</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">è¯çµ¡é›»è©±</label>
                            <input type="tel" id="personnelPhone" placeholder="è¯çµ¡é›»è©±" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å°ˆé•·</label>
                            <input type="text" id="personnelSkills" placeholder="ä¾‹ï¼šä½œç‰©æ ½åŸ¹ã€æ©Ÿæ¢°æ“ä½œ" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors">
                            æ–°å¢äººå“¡
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Management Section -->
    <div id="managementSection" class="hidden min-h-screen bg-gradient-to-br from-orange-50 to-red-50">
        <div class="container mx-auto px-4 py-8 max-w-6xl">
            <button onclick="showSection('cover')" class="mb-6 bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg shadow-md transition-colors flex items-center">
                â† è¿”å›é¦–é 
            </button>

            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ‘¥ äººå“¡è³‡æç®¡ç†</h1>
                <p class="text-gray-600">ç®¡ç†è¾²å ´äººå“¡è³‡è¨Šèˆ‡è³‡æåº«å­˜ç‹€æ³</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Materials Management -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800 flex items-center">
                            <span class="mr-2">ğŸ§ª</span>è³‡æç®¡ç†
                        </h2>
                        <div class="flex space-x-2">
                            <button onclick="showStockReport()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                ğŸ“Š åº«å­˜å ±è¡¨
                            </button>
                        </div>
                    </div>
                    <div id="materialsList" class="space-y-3">
                        <div class="text-center text-gray-500 py-4">
                            å°šç„¡è³‡æè¨˜éŒ„
                        </div>
                    </div>
                </div>

                <!-- Personnel Management -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">ğŸ‘¥</span>äººå“¡ç®¡ç†
                    </h2>
                    <div id="personnelList" class="space-y-3">
                        <div class="text-center text-gray-500 py-4">
                            å°šç„¡äººå“¡è¨˜éŒ„
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- All Logs Section with Calendar -->
    <div id="allLogsSection" class="hidden min-h-screen bg-gradient-to-br from-green-50 to-blue-50">
        <div class="container mx-auto px-4 py-8 max-w-7xl">
            <button onclick="showSection('cover')" class="mb-6 bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg shadow-md transition-colors flex items-center">
                â† è¿”å›é¦–é 
            </button>

            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ“Š æ‰€æœ‰å·¥ä½œæ—¥èªŒ</h1>
                <p class="text-gray-600">æŸ¥çœ‹æ­·å²è¨˜éŒ„èˆ‡çµ±è¨ˆåˆ†æ</p>
            </div>

            <!-- Calendar Navigation -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="changeMonth(-1)" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        â† ä¸Šå€‹æœˆ
                    </button>
                    <h2 id="currentMonth" class="text-2xl font-bold text-gray-800"></h2>
                    <button onclick="changeMonth(1)" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        ä¸‹å€‹æœˆ â†’
                    </button>
                </div>

                <!-- Calendar Grid -->
                <div class="grid grid-cols-7 gap-1">
                    <!-- Day Headers -->
                    <div class="text-center font-semibold text-gray-600 py-2">æ—¥</div>
                    <div class="text-center font-semibold text-gray-600 py-2">ä¸€</div>
                    <div class="text-center font-semibold text-gray-600 py-2">äºŒ</div>
                    <div class="text-center font-semibold text-gray-600 py-2">ä¸‰</div>
                    <div class="text-center font-semibold text-gray-600 py-2">å››</div>
                    <div class="text-center font-semibold text-gray-600 py-2">äº”</div>
                    <div class="text-center font-semibold text-gray-600 py-2">å…­</div>
                    
                    <!-- Calendar Days -->
                    <div id="calendarDays" class="contents"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Details Modal -->
    <div id="dayDetailsModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="modalDate" class="text-2xl font-bold text-gray-800"></h2>
                    <button onclick="closeDayModal()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                </div>
                <div id="dayLogsList" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- Edit Log Modal -->
    <div id="editLogModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">ç·¨è¼¯å·¥ä½œè¨˜éŒ„</h2>
                    <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                </div>
                <form id="editLogForm" class="space-y-6">
                    <!-- Edit form will be populated dynamically -->
                </form>
            </div>
        </div>
    </div>

    <!-- Stock Alert Modal -->
    <div id="stockAlertModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-orange-600 flex items-center">
                        <span class="mr-2">âš ï¸</span>åº«å­˜è­¦ç¤º
                    </h2>
                    <button onclick="closeStockAlert()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                </div>
                <div id="stockAlertContent" class="space-y-4">
                    <!-- Alert content will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Report Modal -->
    <div id="stockReportModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-blue-600 flex items-center">
                        <span class="mr-2">ğŸ“Š</span>åº«å­˜å ±è¡¨
                    </h2>
                    <button onclick="closeStockReport()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                </div>
                <div id="stockReportContent" class="space-y-4">
                    <!-- Report content will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Stock History Modal -->
    <div id="stockHistoryModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="stockHistoryTitle" class="text-2xl font-bold text-blue-600 flex items-center">
                        <span class="mr-2">ğŸ“‹</span>åº«å­˜é€²å‡ºè¨˜éŒ„
                    </h2>
                    <div class="flex space-x-2">
                        <button onclick="adjustStockFromHistory()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors">
                            ğŸ“¦ èª¿æ•´åº«å­˜
                        </button>
                        <button onclick="closeStockHistory()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                    </div>
                </div>
                <div id="stockHistoryContent" class="space-y-4">
                    <!-- History content will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Adjustment Modal -->
    <div id="stockAdjustModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">èª¿æ•´åº«å­˜</h2>
                    <button onclick="closeStockAdjust()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                </div>
                <form id="stockAdjustForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è³‡æåç¨±</label>
                        <input type="text" id="adjustMaterialName" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç›®å‰åº«å­˜</label>
                        <input type="text" id="currentStock" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">èª¿æ•´é¡å‹</label>
                        <select id="adjustType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            <option value="add">å¢åŠ åº«å­˜ (+)</option>
                            <option value="subtract">æ¸›å°‘åº«å­˜ (-)</option>
                            <option value="set">è¨­å®šåº«å­˜ (=)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">èª¿æ•´æ•¸é‡</label>
                        <input type="number" id="adjustAmount" placeholder="è¼¸å…¥æ•¸é‡" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">èª¿æ•´åŸå› </label>
                        <select id="adjustReason" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            <option value="é€²è²¨">é€²è²¨</option>
                            <option value="ç›¤é»èª¿æ•´">ç›¤é»èª¿æ•´</option>
                            <option value="æè€—">æè€—</option>
                            <option value="éæœŸå ±å»¢">éæœŸå ±å»¢</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label>
                        <textarea id="adjustNote" rows="2" placeholder="èª¿æ•´èªªæ˜..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeStockAdjust()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            ç¢ºèªèª¿æ•´
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let logEntries = JSON.parse(localStorage.getItem('farmLogEntries') || '[]');
        let materials = JSON.parse(localStorage.getItem('farmMaterials') || '[]');
        let personnel = JSON.parse(localStorage.getItem('farmPersonnel') || '[]');
        let currentMaterials = [];
        let currentWorkers = [];
        let currentDate = new Date();
        let editingLogId = null;

        // Work type colors
        const WORK_TYPE_COLORS = {
            'æ•´åœ°': 'text-yellow-700 bg-yellow-50 border-yellow-200',
            'æ’­ç¨®/è‚²è‹—': 'text-blue-700 bg-blue-50 border-blue-200',
            'æ–½è‚¥': 'text-green-700 bg-green-50 border-green-200',
            'çŒæº‰': 'text-indigo-700 bg-indigo-50 border-indigo-200',
            'ç—…èŸ²å®³é˜²æ²»': 'text-red-700 bg-red-50 border-red-200',
            'é™¤è‰': 'text-lime-700 bg-lime-50 border-lime-200',
            'ä¿®å‰ª/ç–æœ': 'text-pink-700 bg-pink-50 border-pink-200',
            'æ¡æ”¶': 'text-purple-700 bg-purple-50 border-purple-200',
            'ç¶­è­·': 'text-gray-700 bg-gray-50 border-gray-200',
            'å…¶ä»–': 'text-zinc-700 bg-zinc-50 border-zinc-200',
        };

        // Work type short names for calendar display
        const WORK_TYPE_SHORT = {
            'æ•´åœ°': 'æ•´åœ°',
            'æ’­ç¨®/è‚²è‹—': 'æ’­ç¨®',
            'æ–½è‚¥': 'æ–½è‚¥',
            'çŒæº‰': 'çŒæº‰',
            'ç—…èŸ²å®³é˜²æ²»': 'é˜²æ²»',
            'é™¤è‰': 'é™¤è‰',
            'ä¿®å‰ª/ç–æœ': 'ä¿®å‰ª',
            'æ¡æ”¶': 'æ¡æ”¶',
            'ç¶­è­·': 'ç¶­è­·',
            'å…¶ä»–': 'å…¶ä»–',
        };

        // Conversion factors
        const CONVERSION_FACTORS = {
            'å…‹': 1,
            'å…¬æ–¤': 1000,
            'æ–¤': 600,
            'æ¯«å‡': 1,
            'å…¬å‡': 1000,
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            setupEventListeners();
        });

        // Calculate unit price automatically
        function calculateUnitPrice() {
            const initialStock = parseFloat(document.getElementById('initialStock').value) || 0;
            const totalPrice = parseFloat(document.getElementById('totalPrice').value) || 0;
            const unitPriceField = document.getElementById('unitPrice');
            
            if (initialStock > 0 && totalPrice > 0) {
                const unitPrice = (totalPrice / initialStock).toFixed(1);
                unitPriceField.value = unitPrice;
            } else {
                unitPriceField.value = '';
            }
        }

        // Toggle bottle capacity input based on unit selection
        function toggleBottleCapacity() {
            const stockUnit = document.getElementById('stockUnit').value;
            const bottleCapacityDiv = document.getElementById('bottleCapacityDiv');
            
            if (stockUnit === 'ç“¶') {
                bottleCapacityDiv.classList.remove('hidden');
            } else {
                bottleCapacityDiv.classList.add('hidden');
                // Clear bottle capacity values when hidden
                document.getElementById('bottleCapacity').value = '';
                document.getElementById('bottleCapacityUnit').value = 'æ¯«å‡';
            }
        }

        function setupEventListeners() {
            // Work log form
            const farmLogForm = document.getElementById('farmLogForm');
            if (farmLogForm) {
                farmLogForm.addEventListener('submit', handleWorkLogSubmit);
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                document.getElementById('addMaterialBtn').addEventListener('click', addMaterial);
                document.getElementById('addWorkerBtn').addEventListener('click', addWorker);
                
                // Material search
                document.getElementById('materialName').addEventListener('input', handleMaterialSearch);
                document.getElementById('materialName').addEventListener('blur', () => {
                    setTimeout(() => document.getElementById('materialSuggestions').classList.add('hidden'), 200);
                });
                
                // Worker search
                document.getElementById('workerName').addEventListener('input', handleWorkerSearch);
                document.getElementById('workerName').addEventListener('blur', () => {
                    setTimeout(() => document.getElementById('workerSuggestions').classList.add('hidden'), 200);
                });
                
                ['materialQuantity', 'materialUnit', 'dilutionRatio'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', updateMaterialTotal);
                    }
                });
            }

            // Add material form
            const addMaterialForm = document.getElementById('addMaterialForm');
            if (addMaterialForm) {
                addMaterialForm.addEventListener('submit', handleAddMaterial);
                // è¨­å®šå…¥åº«æ—¥æœŸé è¨­å€¼ç‚ºä»Šå¤©
                const stockDateField = document.getElementById('stockDate');
                if (stockDateField) {
                    stockDateField.value = new Date().toISOString().split('T')[0];
                }
            }

            // Add personnel form
            const addPersonnelForm = document.getElementById('addPersonnelForm');
            if (addPersonnelForm) {
                addPersonnelForm.addEventListener('submit', handleAddPersonnel);
            }
        }

        function showSection(section) {
            // Hide all sections
            document.getElementById('coverPage').classList.add('hidden');
            document.getElementById('workLogSection').classList.add('hidden');
            document.getElementById('addResourcesSection').classList.add('hidden');
            document.getElementById('managementSection').classList.add('hidden');
            document.getElementById('allLogsSection').classList.add('hidden');

            // Show selected section
            if (section === 'cover') {
                document.getElementById('coverPage').classList.remove('hidden');
                updateStats();
            } else if (section === 'workLog') {
                document.getElementById('workLogSection').classList.remove('hidden');
                setupEventListeners();
            } else if (section === 'addResources') {
                document.getElementById('addResourcesSection').classList.remove('hidden');
                setupEventListeners();
            } else if (section === 'management') {
                document.getElementById('managementSection').classList.remove('hidden');
                displayMaterialsManagement();
                displayPersonnelManagement();
            } else if (section === 'allLogs') {
                document.getElementById('allLogsSection').classList.remove('hidden');
                displayCalendar();
            }
        }

        function updateStats() {
            document.getElementById('totalLogs').textContent = logEntries.length;
            
            // è¨ˆç®—ä¸é‡è¤‡çš„è³‡æå“é …æ•¸é‡
            const uniqueMaterials = new Set(materials.map(m => m.name));
            document.getElementById('totalMaterials').textContent = uniqueMaterials.size;
            
            document.getElementById('totalPersonnel').textContent = personnel.length;
        }

        function displayCalendar() {
            const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 
                              'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
            
            document.getElementById('currentMonth').textContent = 
                `${currentDate.getFullYear()}å¹´ ${monthNames[currentDate.getMonth()]}`;
            
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayDiv = document.createElement('div');
                dayDiv.className = `calendar-day border border-gray-200 p-2 cursor-pointer ${
                    date.getMonth() !== currentDate.getMonth() ? 'text-gray-400 bg-gray-50' : 'bg-white hover:bg-gray-50'
                }`;
                
                const dateStr = date.toISOString().split('T')[0];
                const dayLogs = logEntries.filter(log => log.date === dateStr);
                
                dayDiv.innerHTML = `
                    <div class="font-semibold text-lg mb-1">${date.getDate()}</div>
                    <div class="space-y-1">
                        ${dayLogs.map(log => {
                            const workTypeColor = WORK_TYPE_COLORS[log.workType] || 'text-gray-700 bg-gray-50 border-gray-200';
                            const shortName = WORK_TYPE_SHORT[log.workType] || log.workType;
                            return `<div class="work-type-badge ${workTypeColor}" 
                                         onclick="event.stopPropagation(); editLog(${log.id})"
                                         title="é»æ“Šç·¨è¼¯ï¼š${log.workType}">
                                        ${shortName}
                                    </div>`;
                        }).join('')}
                    </div>
                `;
                
                dayDiv.onclick = () => showDayDetails(dateStr);
                calendarDays.appendChild(dayDiv);
            }
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            displayCalendar();
        }

        function showDayDetails(dateStr) {
            const dayLogs = logEntries.filter(log => log.date === dateStr);
            const date = new Date(dateStr + 'T00:00:00');
            
            document.getElementById('modalDate').textContent = 
                `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ å·¥ä½œè¨˜éŒ„`;
            
            const dayLogsList = document.getElementById('dayLogsList');
            
            if (dayLogs.length === 0) {
                dayLogsList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ğŸ“</div>
                        <p>é€™å¤©æ²’æœ‰å·¥ä½œè¨˜éŒ„</p>
                    </div>
                `;
            } else {
                dayLogsList.innerHTML = '';
                dayLogs.forEach(log => {
                    const logDiv = document.createElement('div');
                    logDiv.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow';
                    
                    const workTypeColor = WORK_TYPE_COLORS[log.workType] || 'text-gray-700 bg-gray-50 border-gray-200';
                    
                    let materialsHtml = '';
                    if (log.materials && log.materials.length > 0) {
                        materialsHtml = `
                            <div class="mt-3">
                                <h4 class="text-sm font-medium text-gray-700 mb-2">ä½¿ç”¨è³‡æï¼š</h4>
                                <div class="space-y-1">
                                    ${log.materials.map(material => {
                                        let dilutionText = material.dilution ? ` (ç¨€é‡‹ ${material.dilution} å€)` : '';
                                        let totalText = material.totalMl && material.totalLiters ? 
                                            ` â†’ ${material.totalMl} æ¯«å‡ (${material.totalLiters} å…¬å‡)` : '';
                                        return `<div class="text-sm text-gray-600 bg-gray-50 px-2 py-1 rounded">
                                            ${material.name} - ${material.quantity} ${material.unit}${dilutionText}${totalText}
                                        </div>`;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }

                    let workersHtml = '';
                    if (log.workers && log.workers.length > 0) {
                        const totalHours = log.workers.reduce((sum, worker) => sum + worker.hours, 0);
                        workersHtml = `
                            <div class="mt-3">
                                <h4 class="text-sm font-medium text-gray-700 mb-2">å·¥ä½œäººå“¡ (ç¸½è¨ˆï¼š${totalHours} å°æ™‚)ï¼š</h4>
                                <div class="space-y-1">
                                    ${log.workers.map(worker => {
                                        return `<div class="text-sm text-gray-600 bg-blue-50 px-2 py-1 rounded">
                                            ${worker.name} - ${worker.hours} å°æ™‚
                                        </div>`;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    logDiv.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center space-x-3">
                                <span class="px-3 py-1 rounded-full text-sm font-medium border ${workTypeColor}">
                                    ${log.workType}
                                </span>
                                ${log.weather ? `<span class="text-gray-500">${log.weather}</span>` : ''}
                            </div>
                            <button onclick="editLog(${log.id})" class="text-blue-500 hover:text-blue-700 transition-colors">
                                âœï¸ ç·¨è¼¯
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                ${log.location ? `<p class="text-sm text-gray-600 mb-1"><strong>åœ°é»ï¼š</strong>${log.location}</p>` : ''}
                                ${log.crop ? `<p class="text-sm text-gray-600 mb-1"><strong>ä½œç‰©ï¼š</strong>${log.crop}</p>` : ''}
                                ${log.details ? `<p class="text-sm text-gray-600 mb-1"><strong>ä½œæ¥­è©³æƒ…ï¼š</strong>${log.details}</p>` : ''}
                                ${log.yield ? `<p class="text-sm text-gray-600 mb-1"><strong>ç”¢é‡ï¼š</strong>${log.yield}</p>` : ''}
                            </div>
                            <div>
                                ${log.observations ? `<p class="text-sm text-gray-600 mb-1"><strong>è§€å¯Ÿï¼š</strong>${log.observations}</p>` : ''}
                                ${log.notes ? `<p class="text-sm text-gray-600 mb-1"><strong>å‚™è¨»ï¼š</strong>${log.notes}</p>` : ''}
                            </div>
                        </div>
                        
                        ${materialsHtml}
                        ${workersHtml}
                    `;
                    
                    dayLogsList.appendChild(logDiv);
                });
            }
            
            document.getElementById('dayDetailsModal').classList.remove('hidden');
        }

        function closeDayModal() {
            document.getElementById('dayDetailsModal').classList.add('hidden');
        }

        function editLog(logId) {
            const log = logEntries.find(l => l.id === logId);
            if (!log) return;
            
            editingLogId = logId;
            currentMaterials = [...(log.materials || [])];
            currentWorkers = [...(log.workers || [])];
            
            const editForm = document.getElementById('editLogForm');
            editForm.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ—¥æœŸ</label>
                        <input type="date" id="editDate" value="${log.date}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åœ°é»</label>
                        <input type="text" id="editLocation" value="${log.location || ''}" placeholder="ä¾‹ï¼šAå€ç”°åœ°" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¤©æ°£</label>
                        <select id="editWeather" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                            <option value="">é¸æ“‡å¤©æ°£</option>
                            <option value="æ™´å¤©" ${log.weather === 'æ™´å¤©' ? 'selected' : ''}>â˜€ï¸ æ™´å¤©</option>
                            <option value="å¤šé›²" ${log.weather === 'å¤šé›²' ? 'selected' : ''}>â›… å¤šé›²</option>
                            <option value="é™°å¤©" ${log.weather === 'é™°å¤©' ? 'selected' : ''}>â˜ï¸ é™°å¤©</option>
                            <option value="å°é›¨" ${log.weather === 'å°é›¨' ? 'selected' : ''}>ğŸŒ¦ï¸ å°é›¨</option>
                            <option value="å¤§é›¨" ${log.weather === 'å¤§é›¨' ? 'selected' : ''}>ğŸŒ§ï¸ å¤§é›¨</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä½œæ¥­é¡å‹</label>
                        <select id="editWorkType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                            <option value="">é¸æ“‡ä½œæ¥­é¡å‹</option>
                            <option value="æ•´åœ°" ${log.workType === 'æ•´åœ°' ? 'selected' : ''}>ğŸšœ æ•´åœ°</option>
                            <option value="æ’­ç¨®/è‚²è‹—" ${log.workType === 'æ’­ç¨®/è‚²è‹—' ? 'selected' : ''}>ğŸŒ± æ’­ç¨®/è‚²è‹—</option>
                            <option value="æ–½è‚¥" ${log.workType === 'æ–½è‚¥' ? 'selected' : ''}>ğŸŒ¿ æ–½è‚¥</option>
                            <option value="çŒæº‰" ${log.workType === 'çŒæº‰' ? 'selected' : ''}>ğŸ’§ çŒæº‰</option>
                            <option value="ç—…èŸ²å®³é˜²æ²»" ${log.workType === 'ç—…èŸ²å®³é˜²æ²»' ? 'selected' : ''}>ğŸ› ç—…èŸ²å®³é˜²æ²»</option>
                            <option value="é™¤è‰" ${log.workType === 'é™¤è‰' ? 'selected' : ''}>ğŸŒ¾ é™¤è‰</option>
                            <option value="ä¿®å‰ª/ç–æœ" ${log.workType === 'ä¿®å‰ª/ç–æœ' ? 'selected' : ''}>âœ‚ï¸ ä¿®å‰ª/ç–æœ</option>
                            <option value="æ¡æ”¶" ${log.workType === 'æ¡æ”¶' ? 'selected' : ''}>ğŸ¥• æ¡æ”¶</option>
                            <option value="ç¶­è­·" ${log.workType === 'ç¶­è­·' ? 'selected' : ''}>ğŸ”§ ç¶­è­·</option>
                            <option value="å…¶ä»–" ${log.workType === 'å…¶ä»–' ? 'selected' : ''}>ğŸ“‹ å…¶ä»–</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä½œç‰©</label>
                        <input type="text" id="editCrop" value="${log.crop || ''}" placeholder="ä¾‹ï¼šç•ªèŒ„ã€ç‰ç±³" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                    </div>
                </div>

                <!-- Material Usage Section -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">ğŸ§ª</span>è³‡æä½¿ç”¨
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div class="relative">
                            <label class="block text-sm font-medium text-gray-700 mb-2">è³‡æåç¨±</label>
                            <input type="text" id="editMaterialName" placeholder="è¼¸å…¥é—œéµå­—æœå°‹è³‡æ..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            <div id="editMaterialSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-40 overflow-y-auto"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ä½¿ç”¨é‡</label>
                            <input type="number" id="editMaterialQuantity" placeholder="æ•¸é‡" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å–®ä½</label>
                            <select id="editMaterialUnit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                <option value="æ¯«å‡">æ¯«å‡</option>
                                <option value="å…¬å‡">å…¬å‡</option>
                                <option value="å…‹">å…‹</option>
                                <option value="å…¬æ–¤">å…¬æ–¤</option>
                                <option value="æ–¤">æ–¤</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ç¨€é‡‹å€æ•¸</label>
                            <input type="number" id="editDilutionRatio" placeholder="ä¾‹ï¼š100" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button type="button" onclick="addEditMaterial()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                            <span class="mr-1">â•</span>æ·»åŠ è³‡æ
                        </button>
                    </div>
                    
                    <div id="editMaterialsList" class="space-y-2"></div>
                </div>

                <!-- Work Personnel Section -->
                <div class="bg-gray-50 rounded-lg p-4 mt-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">ğŸ‘¥</span>å·¥ä½œäººå“¡åŠå·¥æ™‚
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="relative">
                            <label class="block text-sm font-medium text-gray-700 mb-2">äººå“¡å§“å</label>
                            <input type="text" id="editWorkerName" placeholder="è¼¸å…¥é—œéµå­—æœå°‹äººå“¡..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                            <div id="editWorkerSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-40 overflow-y-auto"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å·¥ä½œæ™‚æ•¸</label>
                            <input type="number" id="editWorkHours" placeholder="å°æ™‚" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        </div>
                        <div class="flex items-end">
                            <button type="button" onclick="addEditWorker()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center w-full justify-center">
                                <span class="mr-1">â•</span>æ·»åŠ äººå“¡
                            </button>
                        </div>
                    </div>
                    
                    <div id="editWorkersList" class="space-y-2"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä½œæ¥­è©³æƒ…</label>
                        <textarea id="editDetails" rows="3" placeholder="è©³ç´°æè¿°ä½œæ¥­å…§å®¹..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all resize-none">${log.details || ''}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç”¢é‡è¨˜éŒ„</label>
                        <input type="text" id="editYield" value="${log.yield || ''}" placeholder="ä¾‹ï¼šæ”¶ç©« 50 å…¬æ–¤ç•ªèŒ„" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è§€å¯Ÿè¨˜éŒ„</label>
                        <textarea id="editObservations" rows="3" placeholder="è¨˜éŒ„ä½œç‰©ç”Ÿé•·ç‹€æ³ã€ç—…èŸ²å®³ç­‰..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all resize-none">${log.observations || ''}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label>
                        <textarea id="editNotes" rows="3" placeholder="å…¶ä»–éœ€è¦è¨˜éŒ„çš„äº‹é …..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all resize-none">${log.notes || ''}</textarea>
                    </div>
                </div>

                <div class="flex justify-between">
                    <button type="button" onclick="deleteLogEntry(${logId})" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        ğŸ—‘ï¸ åˆªé™¤è¨˜éŒ„
                    </button>
                    <div class="space-x-4">
                        <button type="button" onclick="closeEditModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                            ğŸ’¾ å„²å­˜è®Šæ›´
                        </button>
                    </div>
                </div>
            `;
            
            // Setup edit form event listeners
            setupEditFormListeners();
            displayEditMaterials();
            displayEditWorkers();
            
            document.getElementById('editLogModal').classList.remove('hidden');
        }

        function setupEditFormListeners() {
            // Edit form submission
            document.getElementById('editLogForm').addEventListener('submit', handleEditLogSubmit);
            
            // Material search in edit form
            document.getElementById('editMaterialName').addEventListener('input', handleEditMaterialSearch);
            document.getElementById('editMaterialName').addEventListener('blur', () => {
                setTimeout(() => document.getElementById('editMaterialSuggestions').classList.add('hidden'), 200);
            });
            
            // Worker search in edit form
            document.getElementById('editWorkerName').addEventListener('input', handleEditWorkerSearch);
            document.getElementById('editWorkerName').addEventListener('blur', () => {
                setTimeout(() => document.getElementById('editWorkerSuggestions').classList.add('hidden'), 200);
            });
        }

        function handleEditMaterialSearch() {
            const query = document.getElementById('editMaterialName').value.toLowerCase();
            const suggestions = document.getElementById('editMaterialSuggestions');
            
            if (query.length < 1) {
                suggestions.classList.add('hidden');
                return;
            }
            
            // éæ¿¾ä¸¦å»é‡è¤‡åç¨±çš„è³‡æ
            const filteredMaterials = materials.filter(material => 
                material.name.toLowerCase().includes(query)
            );
            
            // å»é™¤é‡è¤‡åç¨±ï¼Œåªä¿ç•™æ¯å€‹åç¨±çš„ç¬¬ä¸€å€‹é …ç›®
            const uniqueMaterials = [];
            const seenNames = new Set();
            
            filteredMaterials.forEach(material => {
                if (!seenNames.has(material.name)) {
                    seenNames.add(material.name);
                    uniqueMaterials.push(material);
                }
            });
            
            if (uniqueMaterials.length === 0) {
                suggestions.classList.add('hidden');
                return;
            }
            
            suggestions.innerHTML = '';
            uniqueMaterials.forEach(material => {
                const div = document.createElement('div');
                div.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0';
                div.innerHTML = `
                    <div class="font-medium">${material.name}</div>
                    <div class="text-sm text-gray-500">${material.category}</div>
                    ${material.remarks ? `<div class="text-xs text-gray-400">${material.remarks}</div>` : ''}
                `;
                div.onclick = () => {
                    document.getElementById('editMaterialName').value = material.name;
                    suggestions.classList.add('hidden');
                };
                suggestions.appendChild(div);
            });
            
            suggestions.classList.remove('hidden');
        }

        function handleEditWorkerSearch() {
            const query = document.getElementById('editWorkerName').value.toLowerCase();
            const suggestions = document.getElementById('editWorkerSuggestions');
            
            if (query.length < 1) {
                suggestions.classList.add('hidden');
                return;
            }
            
            const filteredPersonnel = personnel.filter(person => 
                person.name.toLowerCase().includes(query)
            );
            
            if (filteredPersonnel.length === 0) {
                suggestions.classList.add('hidden');
                return;
            }
            
            suggestions.innerHTML = '';
            filteredPersonnel.forEach(person => {
                const div = document.createElement('div');
                div.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0';
                div.innerHTML = `
                    <div class="font-medium">${person.name}</div>
                    <div class="text-sm text-gray-500">${person.role}</div>
                `;
                div.onclick = () => {
                    document.getElementById('editWorkerName').value = person.name;
                    suggestions.classList.add('hidden');
                };
                suggestions.appendChild(div);
            });
            
            suggestions.classList.remove('hidden');
        }

        function addEditMaterial() {
            const name = document.getElementById('editMaterialName').value.trim();
            const quantity = document.getElementById('editMaterialQuantity').value;
            const unit = document.getElementById('editMaterialUnit').value;
            const dilution = document.getElementById('editDilutionRatio').value;
            
            if (!name || !quantity) {
                alert('è«‹å¡«å¯«è³‡æåç¨±å’Œä½¿ç”¨é‡');
                return;
            }
            
            const totals = calculateMaterialTotals(quantity, unit, dilution);
            
            const material = {
                name,
                quantity: parseFloat(quantity),
                unit,
                dilution: dilution ? parseFloat(dilution) : null,
                totalMl: totals.totalMl,
                totalLiters: totals.totalLiters
            };
            
            currentMaterials.push(material);
            displayEditMaterials();
            
            // Clear inputs
            document.getElementById('editMaterialName').value = '';
            document.getElementById('editMaterialQuantity').value = '';
            document.getElementById('editDilutionRatio').value = '';
        }

        function addEditWorker() {
            const name = document.getElementById('editWorkerName').value.trim();
            const hours = document.getElementById('editWorkHours').value;
            
            if (!name || !hours) {
                alert('è«‹å¡«å¯«äººå“¡å§“åå’Œå·¥ä½œæ™‚æ•¸');
                return;
            }
            
            const worker = {
                name,
                hours: parseFloat(hours)
            };
            
            currentWorkers.push(worker);
            displayEditWorkers();
            
            // Clear inputs
            document.getElementById('editWorkerName').value = '';
            document.getElementById('editWorkHours').value = '';
        }

        function displayEditMaterials() {
            const container = document.getElementById('editMaterialsList');
            container.innerHTML = '';
            
            currentMaterials.forEach((material, index) => {
                const div = document.createElement('div');
                div.className = 'bg-white border border-gray-200 rounded-lg p-3 flex justify-between items-center';
                
                let dilutionText = material.dilution ? ` (ç¨€é‡‹ ${material.dilution} å€)` : '';
                let totalText = material.totalMl && material.totalLiters ? 
                    ` â†’ ç¸½ç”¨é‡ï¼š${material.totalMl} æ¯«å‡ (${material.totalLiters} å…¬å‡)` : '';
                
                div.innerHTML = `
                    <span class="text-gray-800">
                        <strong>${material.name}</strong> - ${material.quantity} ${material.unit}${dilutionText}${totalText}
                    </span>
                    <button onclick="removeEditMaterial(${index})" class="text-red-500 hover:text-red-700 transition-colors">
                        ğŸ—‘ï¸
                    </button>
                `;
                
                container.appendChild(div);
            });
        }

        function displayEditWorkers() {
            const container = document.getElementById('editWorkersList');
            container.innerHTML = '';
            
            currentWorkers.forEach((worker, index) => {
                const div = document.createElement('div');
                div.className = 'bg-white border border-gray-200 rounded-lg p-3 flex justify-between items-center';
                
                div.innerHTML = `
                    <span class="text-gray-800">
                        <strong>${worker.name}</strong> - ${worker.hours} å°æ™‚
                    </span>
                    <button onclick="removeEditWorker(${index})" class="text-red-500 hover:text-red-700 transition-colors">
                        ğŸ—‘ï¸
                    </button>
                `;
                
                container.appendChild(div);
            });
        }

        function removeEditMaterial(index) {
            currentMaterials.splice(index, 1);
            displayEditMaterials();
        }

        function removeEditWorker(index) {
            currentWorkers.splice(index, 1);
            displayEditWorkers();
        }

        function handleEditLogSubmit(e) {
            e.preventDefault();
            
            const updatedLog = {
                id: editingLogId,
                date: document.getElementById('editDate').value,
                location: document.getElementById('editLocation').value,
                weather: document.getElementById('editWeather').value,
                workType: document.getElementById('editWorkType').value,
                crop: document.getElementById('editCrop').value,
                details: document.getElementById('editDetails').value,
                yield: document.getElementById('editYield').value,
                observations: document.getElementById('editObservations').value,
                notes: document.getElementById('editNotes').value,
                materials: [...currentMaterials],
                workers: [...currentWorkers],
                timestamp: new Date().toISOString()
            };
            
            if (!updatedLog.date || !updatedLog.workType) {
                alert('è«‹å¡«å¯«æ—¥æœŸå’Œä½œæ¥­é¡å‹');
                return;
            }
            
            const logIndex = logEntries.findIndex(log => log.id === editingLogId);
            if (logIndex !== -1) {
                const originalLog = logEntries[logIndex];
                
                // å…ˆå›å¾©åŸæœ¬çš„åº«å­˜
                if (originalLog.materials && originalLog.materials.length > 0) {
                    restoreMaterialStock(originalLog.materials);
                }
                
                // å†æ‰£é™¤æ–°çš„ä½¿ç”¨é‡
                if (updatedLog.materials && updatedLog.materials.length > 0) {
                    updateMaterialStock(updatedLog.materials);
                }
                
                logEntries[logIndex] = updatedLog;
                localStorage.setItem('farmLogEntries', JSON.stringify(logEntries));
                
                closeEditModal();
                displayCalendar();
                showNotification('å·¥ä½œè¨˜éŒ„å·²æ›´æ–°ï¼', 'success');
            }
        }

        function closeEditModal() {
            document.getElementById('editLogModal').classList.add('hidden');
            editingLogId = null;
            currentMaterials = [];
            currentWorkers = [];
        }

        function calculateMaterialTotals(quantity, unit, dilution) {
            const usage = parseFloat(quantity);
            const dilutionRatio = parseFloat(dilution);
            
            if (isNaN(usage) || !unit) return { totalMl: '', totalLiters: '' };
            
            const usageInMl = usage * (CONVERSION_FACTORS[unit] || 1);
            let totalMl;
            
            if (!isNaN(dilutionRatio) && dilutionRatio !== 0) {
                totalMl = Math.round(usageInMl * dilutionRatio);
            } else {
                totalMl = Math.round(usageInMl);
            }
            
            const totalLiters = (totalMl / 1000).toFixed(1);
            
            return { totalMl: String(totalMl), totalLiters: String(totalLiters) };
        }

        function updateMaterialTotal() {
            const quantity = document.getElementById('materialQuantity').value;
            const unit = document.getElementById('materialUnit').value;
            const dilution = document.getElementById('dilutionRatio').value;
            
            const totals = calculateMaterialTotals(quantity, unit, dilution);
            const totalDiv = document.getElementById('materialTotal');
            const totalAmount = document.getElementById('totalAmount');
            
            if (totals.totalMl && totals.totalLiters) {
                totalAmount.textContent = `${totals.totalMl} æ¯«å‡ (${totals.totalLiters} å…¬å‡)`;
                totalDiv.classList.remove('hidden');
            } else {
                totalDiv.classList.add('hidden');
            }
        }

        function addMaterial() {
            const name = document.getElementById('materialName').value.trim();
            const quantity = document.getElementById('materialQuantity').value;
            const unit = document.getElementById('materialUnit').value;
            const dilution = document.getElementById('dilutionRatio').value;
            
            if (!name || !quantity) {
                alert('è«‹å¡«å¯«è³‡æåç¨±å’Œä½¿ç”¨é‡');
                return;
            }
            
            const totals = calculateMaterialTotals(quantity, unit, dilution);
            
            const material = {
                name,
                quantity: parseFloat(quantity),
                unit,
                dilution: dilution ? parseFloat(dilution) : null,
                totalMl: totals.totalMl,
                totalLiters: totals.totalLiters
            };
            
            currentMaterials.push(material);
            displayCurrentMaterials();
            
            // Clear inputs
            document.getElementById('materialName').value = '';
            document.getElementById('materialQuantity').value = '';
            document.getElementById('dilutionRatio').value = '';
            document.getElementById('materialTotal').classList.add('hidden');
        }

        function displayCurrentMaterials() {
            const container = document.getElementById('materialsList');
            container.innerHTML = '';
            
            currentMaterials.forEach((material, index) => {
                const div = document.createElement('div');
                div.className = 'bg-white border border-gray-200 rounded-lg p-3 flex justify-between items-center';
                
                let dilutionText = material.dilution ? ` (ç¨€é‡‹ ${material.dilution} å€)` : '';
                let totalText = material.totalMl && material.totalLiters ? 
                    ` â†’ ç¸½ç”¨é‡ï¼š${material.totalMl} æ¯«å‡ (${material.totalLiters} å…¬å‡)` : '';
                
                div.innerHTML = `
                    <span class="text-gray-800">
                        <strong>${material.name}</strong> - ${material.quantity} ${material.unit}${dilutionText}${totalText}
                    </span>
                    <button onclick="removeCurrentMaterial(${index})" class="text-red-500 hover:text-red-700 transition-colors">
                        ğŸ—‘ï¸
                    </button>
                `;
                
                container.appendChild(div);
            });
        }

        function removeCurrentMaterial(index) {
            currentMaterials.splice(index, 1);
            displayCurrentMaterials();
        }

        function handleMaterialSearch() {
            const query = document.getElementById('materialName').value.toLowerCase();
            const suggestions = document.getElementById('materialSuggestions');
            
            if (query.length < 1) {
                suggestions.classList.add('hidden');
                return;
            }
            
            // éæ¿¾ä¸¦å»é‡è¤‡åç¨±çš„è³‡æ
            const filteredMaterials = materials.filter(material => 
                material.name.toLowerCase().includes(query)
            );
            
            // å»é™¤é‡è¤‡åç¨±ï¼Œåªä¿ç•™æ¯å€‹åç¨±çš„ç¬¬ä¸€å€‹é …ç›®
            const uniqueMaterials = [];
            const seenNames = new Set();
            
            filteredMaterials.forEach(material => {
                if (!seenNames.has(material.name)) {
                    seenNames.add(material.name);
                    uniqueMaterials.push(material);
                }
            });
            
            if (uniqueMaterials.length === 0) {
                suggestions.classList.add('hidden');
                return;
            }
            
            suggestions.innerHTML = '';
            uniqueMaterials.forEach(material => {
                const div = document.createElement('div');
                div.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0';
                div.innerHTML = `
                    <div class="font-medium">${material.name}</div>
                    <div class="text-sm text-gray-500">${material.category}</div>
                    ${material.remarks ? `<div class="text-xs text-gray-400">${material.remarks}</div>` : ''}
                `;
                div.onclick = () => {
                    document.getElementById('materialName').value = material.name;
                    suggestions.classList.add('hidden');
                };
                suggestions.appendChild(div);
            });
            
            suggestions.classList.remove('hidden');
        }

        function handleWorkerSearch() {
            const query = document.getElementById('workerName').value.toLowerCase();
            const suggestions = document.getElementById('workerSuggestions');
            
            if (query.length < 1) {
                suggestions.classList.add('hidden');
                return;
            }
            
            const filteredPersonnel = personnel.filter(person => 
                person.name.toLowerCase().includes(query)
            );
            
            if (filteredPersonnel.length === 0) {
                suggestions.classList.add('hidden');
                return;
            }
            
            suggestions.innerHTML = '';
            filteredPersonnel.forEach(person => {
                const div = document.createElement('div');
                div.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0';
                div.innerHTML = `
                    <div class="font-medium">${person.name}</div>
                    <div class="text-sm text-gray-500">${person.role}</div>
                `;
                div.onclick = () => {
                    document.getElementById('workerName').value = person.name;
                    suggestions.classList.add('hidden');
                };
                suggestions.appendChild(div);
            });
            
            suggestions.classList.remove('hidden');
        }

        function addWorker() {
            const name = document.getElementById('workerName').value.trim();
            const hours = document.getElementById('workHours').value;
            
            if (!name || !hours) {
                alert('è«‹å¡«å¯«äººå“¡å§“åå’Œå·¥ä½œæ™‚æ•¸');
                return;
            }
            
            const worker = {
                name,
                hours: parseFloat(hours)
            };
            
            currentWorkers.push(worker);
            displayCurrentWorkers();
            
            // Clear inputs
            document.getElementById('workerName').value = '';
            document.getElementById('workHours').value = '';
        }

        function displayCurrentWorkers() {
            const container = document.getElementById('workersList');
            container.innerHTML = '';
            
            currentWorkers.forEach((worker, index) => {
                const div = document.createElement('div');
                div.className = 'bg-white border border-gray-200 rounded-lg p-3 flex justify-between items-center';
                
                div.innerHTML = `
                    <span class="text-gray-800">
                        <strong>${worker.name}</strong> - ${worker.hours} å°æ™‚
                    </span>
                    <button onclick="removeCurrentWorker(${index})" class="text-red-500 hover:text-red-700 transition-colors">
                        ğŸ—‘ï¸
                    </button>
                `;
                
                container.appendChild(div);
            });
        }

        function removeCurrentWorker(index) {
            currentWorkers.splice(index, 1);
            displayCurrentWorkers();
        }

        function handleWorkLogSubmit(e) {
            e.preventDefault();
            
            const formData = {
                id: Date.now(),
                date: document.getElementById('date').value,
                location: document.getElementById('location').value,
                weather: document.getElementById('weather').value,
                workType: document.getElementById('workType').value,
                crop: document.getElementById('crop').value,
                details: document.getElementById('details').value,
                yield: document.getElementById('yield').value,
                observations: document.getElementById('observations').value,
                notes: document.getElementById('notes').value,
                materials: [...currentMaterials],
                workers: [...currentWorkers],
                timestamp: new Date().toISOString()
            };
            
            if (!formData.date || !formData.workType) {
                alert('è«‹å¡«å¯«æ—¥æœŸå’Œä½œæ¥­é¡å‹');
                return;
            }
            
            // è‡ªå‹•æ‰£é™¤åº«å­˜
            updateMaterialStock(currentMaterials);
            
            logEntries.unshift(formData);
            localStorage.setItem('farmLogEntries', JSON.stringify(logEntries));
            
            // Reset form
            document.getElementById('farmLogForm').reset();
            currentMaterials = [];
            currentWorkers = [];
            displayCurrentMaterials();
            displayCurrentWorkers();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            
            showNotification('å·¥ä½œæ—¥èªŒå·²æˆåŠŸå„²å­˜ï¼', 'success');
        }

        function updateMaterialStock(usedMaterials) {
            usedMaterials.forEach(usedMaterial => {
                const materialIndex = materials.findIndex(m => m.name === usedMaterial.name);
                
                if (materialIndex !== -1) {
                    const material = materials[materialIndex];
                    
                    if (material.stockUnit === 'ç“¶' && material.bottleCapacity) {
                        // ç“¶è£è³‡æçš„ç‰¹æ®Šè™•ç†
                        updateBottleStock(material, usedMaterial);
                    } else {
                        // ä¸€èˆ¬è³‡æçš„è™•ç†
                        updateRegularStock(material, usedMaterial);
                    }
                }
            });
            
            // å„²å­˜æ›´æ–°å¾Œçš„è³‡æè³‡æ–™
            localStorage.setItem('farmMaterials', JSON.stringify(materials));
        }

        function updateBottleStock(material, usedMaterial) {
            // è¨ˆç®—ä½¿ç”¨çš„æ¯«å‡æ•¸
            let usedMl = 0;
            if (usedMaterial.unit === 'æ¯«å‡') {
                usedMl = usedMaterial.quantity;
            } else if (usedMaterial.unit === 'å…¬å‡') {
                usedMl = usedMaterial.quantity * 1000;
            } else {
                // å…¶ä»–å–®ä½æš«æ™‚æŒ‰åŸæ•¸å€¼è™•ç†
                usedMl = usedMaterial.quantity;
            }
            
            // åˆå§‹åŒ–ç“¶è£åº«å­˜è³‡æ–™
            if (!material.bottleStock) {
                material.bottleStock = {
                    unopenedBottles: material.currentStock || 0,
                    openedBottleMl: 0
                };
            }
            
            let remainingUsage = usedMl;
            const bottleCapacityMl = material.bottleCapacityUnit === 'å…¬å‡' ? 
                material.bottleCapacity * 1000 : material.bottleCapacity;
            
            // å…ˆå¾å·²é–‹å°çš„ç“¶å­æ‰£é™¤
            if (material.bottleStock.openedBottleMl > 0 && remainingUsage > 0) {
                const usedFromOpened = Math.min(remainingUsage, material.bottleStock.openedBottleMl);
                material.bottleStock.openedBottleMl -= usedFromOpened;
                remainingUsage -= usedFromOpened;
            }
            
            // å¦‚æœé‚„æœ‰å‰©é¤˜ä½¿ç”¨é‡ï¼Œé–‹å•Ÿæ–°ç“¶å­
            while (remainingUsage > 0 && material.bottleStock.unopenedBottles > 0) {
                material.bottleStock.unopenedBottles -= 1;
                const usedFromNewBottle = Math.min(remainingUsage, bottleCapacityMl);
                material.bottleStock.openedBottleMl = bottleCapacityMl - usedFromNewBottle;
                remainingUsage -= usedFromNewBottle;
            }
            
            // æ›´æ–°ç¸½åº«å­˜ï¼ˆä»¥ç“¶ç‚ºå–®ä½çš„é¡¯ç¤ºå€¼ï¼‰
            material.currentStock = material.bottleStock.unopenedBottles + 
                (material.bottleStock.openedBottleMl > 0 ? 1 : 0);
            
            // è¨˜éŒ„åº«å­˜ç•°å‹•
            if (!material.stockHistory) {
                material.stockHistory = [];
            }
            
            const workTypeElement = document.getElementById('workType');
            const workType = workTypeElement ? workTypeElement.value : 'è¾²å ´ä½œæ¥­';
            
            material.stockHistory.push({
                date: new Date().toISOString(),
                type: 'usage',
                amount: -usedMl,
                previousStock: material.currentStock,
                newStock: material.currentStock,
                reason: 'è¾²å ´ä½œæ¥­ä½¿ç”¨',
                note: `${workType} - ä½¿ç”¨ ${usedMaterial.quantity} ${usedMaterial.unit}${usedMaterial.dilution ? ` (ç¨€é‡‹${usedMaterial.dilution}å€)` : ''} | å‰©é¤˜ï¼šæœªé–‹å°${material.bottleStock.unopenedBottles}ç“¶ï¼Œé–‹å°${material.bottleStock.openedBottleMl}æ¯«å‡`,
                bottleStock: {
                    unopenedBottles: material.bottleStock.unopenedBottles,
                    openedBottleMl: material.bottleStock.openedBottleMl
                }
            });
            
            console.log(`ç“¶è£åº«å­˜æ›´æ–°: ${material.name} - ä½¿ç”¨ ${usedMl}æ¯«å‡, å‰©é¤˜ï¼šæœªé–‹å°${material.bottleStock.unopenedBottles}ç“¶ï¼Œé–‹å°${material.bottleStock.openedBottleMl}æ¯«å‡`);
        }

        function updateRegularStock(material, usedMaterial) {
            // è¨ˆç®—å¯¦éš›ä½¿ç”¨é‡ï¼ˆè½‰æ›ç‚ºåº«å­˜å–®ä½ï¼‰
            let usageInStockUnit = convertToStockUnit(
                usedMaterial.quantity, 
                usedMaterial.unit, 
                material.stockUnit
            );
            
            // ç¢ºä¿åº«å­˜æ•¸å€¼æ­£ç¢º
            const currentStock = parseFloat(material.currentStock) || 0;
            
            // æ‰£é™¤åº«å­˜
            const newStock = Math.max(0, currentStock - usageInStockUnit);
            material.currentStock = newStock;
            
            // è¨˜éŒ„åº«å­˜ç•°å‹•
            if (!material.stockHistory) {
                material.stockHistory = [];
            }
            
            const workTypeElement = document.getElementById('workType');
            const workType = workTypeElement ? workTypeElement.value : 'è¾²å ´ä½œæ¥­';
            
            material.stockHistory.push({
                date: new Date().toISOString(),
                type: 'usage',
                amount: -usageInStockUnit,
                previousStock: currentStock,
                newStock: newStock,
                reason: 'è¾²å ´ä½œæ¥­ä½¿ç”¨',
                note: `${workType} - ${usedMaterial.quantity} ${usedMaterial.unit}${usedMaterial.dilution ? ` (ç¨€é‡‹${usedMaterial.dilution}å€)` : ''}`
            });
            
            console.log(`åº«å­˜æ›´æ–°: ${material.name} - ä½¿ç”¨ ${usageInStockUnit} ${material.stockUnit}, å¾ ${currentStock} è®Šç‚º ${newStock}`);
        }

        function convertToStockUnit(quantity, fromUnit, toUnit) {
            if (fromUnit === toUnit) return quantity;
            
            // è½‰æ›ç‚ºåŸºæœ¬å–®ä½ï¼ˆæ¯«å‡æˆ–å…‹ï¼‰
            const fromFactor = CONVERSION_FACTORS[fromUnit] || 1;
            const toFactor = CONVERSION_FACTORS[toUnit] || 1;
            
            // å¦‚æœå–®ä½ç³»çµ±ä¸åŒï¼ˆæ¶²é«”vså›ºé«”ï¼‰ï¼Œç›´æ¥è¿”å›åŸæ•¸é‡
            const liquidUnits = ['æ¯«å‡', 'å…¬å‡'];
            const solidUnits = ['å…‹', 'å…¬æ–¤', 'æ–¤'];
            
            const fromIsLiquid = liquidUnits.includes(fromUnit);
            const toIsLiquid = liquidUnits.includes(toUnit);
            
            if (fromIsLiquid !== toIsLiquid) {
                return quantity; // ä¸åŒå–®ä½ç³»çµ±ï¼Œç„¡æ³•è½‰æ›
            }
            
            // ç›¸åŒå–®ä½ç³»çµ±ï¼Œé€²è¡Œè½‰æ›
            const baseQuantity = quantity * fromFactor;
            return baseQuantity / toFactor;
        }

        function restoreMaterialStock(usedMaterials) {
            usedMaterials.forEach(usedMaterial => {
                const materialIndex = materials.findIndex(m => m.name === usedMaterial.name);
                
                if (materialIndex !== -1) {
                    const material = materials[materialIndex];
                    
                    if (material.stockUnit === 'ç“¶' && material.bottleCapacity) {
                        // ç“¶è£è³‡æçš„ç‰¹æ®Šè™•ç†
                        restoreBottleStock(material, usedMaterial);
                    } else {
                        // ä¸€èˆ¬è³‡æçš„è™•ç†
                        restoreRegularStock(material, usedMaterial);
                    }
                }
            });
            
            // å„²å­˜æ›´æ–°å¾Œçš„è³‡æè³‡æ–™
            localStorage.setItem('farmMaterials', JSON.stringify(materials));
        }

        function restoreBottleStock(material, usedMaterial) {
            // è¨ˆç®—è¦å›å¾©çš„æ¯«å‡æ•¸
            let restoreMl = 0;
            if (usedMaterial.unit === 'æ¯«å‡') {
                restoreMl = usedMaterial.quantity;
            } else if (usedMaterial.unit === 'å…¬å‡') {
                restoreMl = usedMaterial.quantity * 1000;
            } else {
                restoreMl = usedMaterial.quantity;
            }
            
            // åˆå§‹åŒ–ç“¶è£åº«å­˜è³‡æ–™
            if (!material.bottleStock) {
                material.bottleStock = {
                    unopenedBottles: 0,
                    openedBottleMl: 0
                };
            }
            
            const bottleCapacityMl = material.bottleCapacityUnit === 'å…¬å‡' ? 
                material.bottleCapacity * 1000 : material.bottleCapacity;
            
            // å…ˆåŠ åˆ°å·²é–‹å°çš„ç“¶å­
            let remainingRestore = restoreMl;
            const canAddToOpened = bottleCapacityMl - material.bottleStock.openedBottleMl;
            
            if (canAddToOpened > 0 && remainingRestore > 0) {
                const addToOpened = Math.min(remainingRestore, canAddToOpened);
                material.bottleStock.openedBottleMl += addToOpened;
                remainingRestore -= addToOpened;
            }
            
            // å¦‚æœé‚„æœ‰å‰©é¤˜ï¼Œå¢åŠ æœªé–‹å°ç“¶å­
            while (remainingRestore > 0) {
                material.bottleStock.unopenedBottles += 1;
                const addToNewBottle = Math.min(remainingRestore, bottleCapacityMl);
                if (addToNewBottle < bottleCapacityMl) {
                    // æ–°ç“¶å­æ²’æœ‰è£æ»¿ï¼Œè®Šæˆé–‹å°ç‹€æ…‹
                    material.bottleStock.openedBottleMl = addToNewBottle;
                    material.bottleStock.unopenedBottles -= 1;
                }
                remainingRestore -= addToNewBottle;
            }
            
            // æ›´æ–°ç¸½åº«å­˜
            material.currentStock = material.bottleStock.unopenedBottles + 
                (material.bottleStock.openedBottleMl > 0 ? 1 : 0);
            
            // è¨˜éŒ„åº«å­˜ç•°å‹•
            if (!material.stockHistory) {
                material.stockHistory = [];
            }
            
            material.stockHistory.push({
                date: new Date().toISOString(),
                type: 'restore',
                amount: restoreMl,
                previousStock: material.currentStock,
                newStock: material.currentStock,
                reason: 'ç·¨è¼¯è¨˜éŒ„å›å¾©',
                note: `å›å¾©åº«å­˜ - ${usedMaterial.quantity} ${usedMaterial.unit}${usedMaterial.dilution ? ` (ç¨€é‡‹${usedMaterial.dilution}å€)` : ''} | ç¾æ³ï¼šæœªé–‹å°${material.bottleStock.unopenedBottles}ç“¶ï¼Œé–‹å°${material.bottleStock.openedBottleMl}æ¯«å‡`,
                bottleStock: {
                    unopenedBottles: material.bottleStock.unopenedBottles,
                    openedBottleMl: material.bottleStock.openedBottleMl
                }
            });
            
            console.log(`ç“¶è£åº«å­˜å›å¾©: ${material.name} - å›å¾© ${restoreMl}æ¯«å‡, ç¾æ³ï¼šæœªé–‹å°${material.bottleStock.unopenedBottles}ç“¶ï¼Œé–‹å°${material.bottleStock.openedBottleMl}æ¯«å‡`);
        }

        function restoreRegularStock(material, usedMaterial) {
            // è¨ˆç®—å¯¦éš›ä½¿ç”¨é‡ï¼ˆè½‰æ›ç‚ºåº«å­˜å–®ä½ï¼‰
            let usageInStockUnit = convertToStockUnit(
                usedMaterial.quantity, 
                usedMaterial.unit, 
                material.stockUnit
            );
            
            // ç¢ºä¿åº«å­˜æ•¸å€¼æ­£ç¢º
            const currentStock = parseFloat(material.currentStock) || 0;
            
            // å›å¾©åº«å­˜
            const newStock = currentStock + usageInStockUnit;
            material.currentStock = newStock;
            
            // è¨˜éŒ„åº«å­˜ç•°å‹•
            if (!material.stockHistory) {
                material.stockHistory = [];
            }
            
            material.stockHistory.push({
                date: new Date().toISOString(),
                type: 'restore',
                amount: usageInStockUnit,
                previousStock: currentStock,
                newStock: newStock,
                reason: 'ç·¨è¼¯è¨˜éŒ„å›å¾©',
                note: `å›å¾©åº«å­˜ - ${usedMaterial.quantity} ${usedMaterial.unit}${usedMaterial.dilution ? ` (ç¨€é‡‹${usedMaterial.dilution}å€)` : ''}`
            });
            
            console.log(`åº«å­˜å›å¾©: ${material.name} - å›å¾© ${usageInStockUnit} ${material.stockUnit}, å¾ ${currentStock} è®Šç‚º ${newStock}`);
        }

        function handleAddMaterial(e) {
            e.preventDefault();
            
            const initialStock = parseFloat(document.getElementById('initialStock').value) || 0;
            const totalPrice = parseFloat(document.getElementById('totalPrice').value) || 0;
            const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
            const stockDate = document.getElementById('stockDate').value || new Date().toISOString().split('T')[0];
            const stockUnit = document.getElementById('stockUnit').value;
            
            // è™•ç†ç“¶è£å®¹é‡
            let bottleCapacity = null;
            let bottleCapacityUnit = null;
            if (stockUnit === 'ç“¶') {
                bottleCapacity = parseFloat(document.getElementById('bottleCapacity').value);
                bottleCapacityUnit = document.getElementById('bottleCapacityUnit').value;
                
                if (!bottleCapacity || bottleCapacity <= 0) {
                    alert('é¸æ“‡ç“¶è£å–®ä½æ™‚ï¼Œè«‹å¡«å¯«æ¯ç“¶å®¹é‡');
                    return;
                }
            }
            
            const material = {
                id: Date.now(),
                name: document.getElementById('newMaterialName').value,
                category: document.getElementById('materialCategory').value,
                remarks: document.getElementById('materialRemarks').value,
                stockDate: stockDate,
                // åº«å­˜ç®¡ç†æ¬„ä½
                currentStock: initialStock,
                stockUnit: stockUnit,
                bottleCapacity: bottleCapacity,
                bottleCapacityUnit: bottleCapacityUnit,
                totalPrice: totalPrice,
                unitPrice: unitPrice,
                // åº«å­˜è¨˜éŒ„
                stockHistory: [{
                    date: stockDate + 'T00:00:00.000Z',
                    type: 'initial',
                    amount: initialStock,
                    newStock: initialStock,
                    reason: 'åˆå§‹åº«å­˜',
                    note: `å»ºç«‹è³‡ææ™‚çš„åˆå§‹åº«å­˜ - ç¸½åƒ¹ï¼š$${totalPrice}ï¼Œå–®åƒ¹ï¼š$${unitPrice}${bottleCapacity ? `ï¼Œæ¯ç“¶å®¹é‡ï¼š${bottleCapacity}${bottleCapacityUnit}` : ''}`
                }]
            };
            
            // å¦‚æœæ˜¯ç“¶è£è³‡æï¼Œåˆå§‹åŒ–ç“¶è£åº«å­˜è³‡æ–™
            if (stockUnit === 'ç“¶' && bottleCapacity) {
                material.bottleStock = {
                    unopenedBottles: initialStock,
                    openedBottleMl: 0
                };
            }
            
            if (!material.name || !material.category) {
                alert('è«‹å¡«å¯«è³‡æåç¨±å’Œé¡åˆ¥');
                return;
            }
            
            materials.push(material);
            localStorage.setItem('farmMaterials', JSON.stringify(materials));
            
            document.getElementById('addMaterialForm').reset();
            document.getElementById('unitPrice').value = '';
            document.getElementById('bottleCapacityDiv').classList.add('hidden');
            // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
            document.getElementById('stockDate').value = new Date().toISOString().split('T')[0];
            showNotification('è³‡æå·²æˆåŠŸæ–°å¢ï¼', 'success');
        }

        function handleAddPersonnel(e) {
            e.preventDefault();
            
            const person = {
                id: Date.now(),
                name: document.getElementById('personnelName').value,
                role: document.getElementById('personnelRole').value,
                phone: document.getElementById('personnelPhone').value,
                skills: document.getElementById('personnelSkills').value
            };
            
            if (!person.name || !person.role) {
                alert('è«‹å¡«å¯«å§“åå’Œè·ä½');
                return;
            }
            
            personnel.push(person);
            localStorage.setItem('farmPersonnel', JSON.stringify(personnel));
            
            document.getElementById('addPersonnelForm').reset();
            showNotification('äººå“¡å·²æˆåŠŸæ–°å¢ï¼', 'success');
        }

        function displayMaterialsManagement() {
            const container = document.querySelector('#managementSection #materialsList');
            
            if (materials.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">å°šç„¡è³‡æè¨˜éŒ„</div>';
                return;
            }
            
            // åˆä½µåŒåè³‡æ
            const mergedMaterials = mergeMaterialsByName(materials);
            
            container.innerHTML = '';
            mergedMaterials.forEach((material, index) => {
                const div = document.createElement('div');
                div.className = 'border border-gray-200 rounded-lg p-4';
                
                const stockValue = material.totalStock || 0;
                const stockUnit = material.stockUnit || 'å€‹';
                const avgUnitPrice = material.avgUnitPrice || 0;
                const totalValue = avgUnitPrice > 0 ? (stockValue * avgUnitPrice).toFixed(2) : '0.00';
                
                // é¡¯ç¤ºç“¶è£å®¹é‡è³‡è¨Šå’Œåº«å­˜è©³æƒ…
                let capacityInfo = '';
                let stockDisplay = `${stockValue.toFixed(1)} ${stockUnit}`;
                
                if (material.stockUnit === 'ç“¶' && material.bottleCapacity) {
                    capacityInfo = `<span class="text-xs text-blue-500 bg-blue-100 px-2 py-1 rounded ml-2">æ¯ç“¶ ${material.bottleCapacity}${material.bottleCapacityUnit}</span>`;
                    
                    // è¨ˆç®—ç“¶è£åº«å­˜è©³æƒ…
                    let totalUnopenedBottles = 0;
                    let totalOpenedMl = 0;
                    
                    material.batches.forEach(batch => {
                        if (batch.bottleStock) {
                            totalUnopenedBottles += batch.bottleStock.unopenedBottles || 0;
                            totalOpenedMl += batch.bottleStock.openedBottleMl || 0;
                        } else {
                            // èˆŠè³‡æ–™æ²’æœ‰ bottleStockï¼Œè¦–ç‚ºå…¨éƒ¨æœªé–‹å°
                            totalUnopenedBottles += batch.currentStock || 0;
                        }
                    });
                    
                    if (totalOpenedMl > 0) {
                        stockDisplay = `æœªé–‹å° ${totalUnopenedBottles} ç“¶ï¼Œé–‹å° ${Math.round(totalOpenedMl)} æ¯«å‡`;
                    } else {
                        stockDisplay = `æœªé–‹å° ${totalUnopenedBottles} ç“¶`;
                    }
                }

                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <h4 class="font-medium text-gray-800">${material.name}</h4>
                                ${material.batchCount > 1 ? `<span class="text-xs text-blue-500 bg-blue-100 px-2 py-1 rounded">${material.batchCount} æ‰¹æ¬¡</span>` : ''}
                                ${capacityInfo}
                            </div>
                            <p class="text-sm text-gray-600">é¡åˆ¥ï¼š${material.category}</p>
                            <div class="flex items-center space-x-4 mt-2">
                                <span class="text-sm text-green-600 bg-green-50 px-2 py-1 rounded">
                                    ç¸½åº«å­˜ï¼š${stockDisplay}
                                </span>
                            </div>
                            ${material.remarks ? `<p class="text-sm text-gray-500 mt-1">å‚™è¨»ï¼š${material.remarks}</p>` : ''}
                        </div>
                        <div class="flex space-x-2 ml-4">
                            <button onclick="adjustStockByName('${material.name}')" class="text-blue-500 hover:text-blue-700 text-sm px-2 py-1 rounded border border-blue-300 hover:bg-blue-50 transition-colors">
                                ğŸ“¦ èª¿æ•´
                            </button>
                            <button onclick="deleteMaterialByName('${material.name}')" class="text-red-500 hover:text-red-700 px-3 py-2 rounded hover:bg-red-50 transition-colors cursor-pointer border border-red-300 hover:border-red-500">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function mergeMaterialsByName(materials) {
            const merged = {};
            
            materials.forEach(material => {
                const name = material.name;
                
                if (!merged[name]) {
                    merged[name] = {
                        name: name,
                        category: material.category,
                        remarks: material.remarks,
                        stockUnit: material.stockUnit || 'å€‹',
                        bottleCapacity: material.bottleCapacity,
                        bottleCapacityUnit: material.bottleCapacityUnit,
                        totalStock: 0,
                        totalCost: 0,
                        avgUnitPrice: 0,
                        batchCount: 0,
                        batches: []
                    };
                }
                
                const currentStock = material.currentStock || 0;
                const unitPrice = material.unitPrice || 0;
                const totalPrice = material.totalPrice || 0;
                
                merged[name].totalStock += currentStock;
                merged[name].totalCost += totalPrice;
                merged[name].batchCount += 1;
                merged[name].batches.push(material);
                
                // è¨ˆç®—åŠ æ¬Šå¹³å‡å–®åƒ¹
                if (merged[name].totalStock > 0) {
                    merged[name].avgUnitPrice = merged[name].totalCost / merged[name].totalStock;
                }
            });
            
            return Object.values(merged);
        }

        function displayPersonnelManagement() {
            const container = document.querySelector('#managementSection #personnelList');
            
            if (personnel.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">å°šç„¡äººå“¡è¨˜éŒ„</div>';
                return;
            }
            
            container.innerHTML = '';
            personnel.forEach((person, index) => {
                const div = document.createElement('div');
                div.className = 'border border-gray-200 rounded-lg p-4 flex justify-between items-center';
                div.innerHTML = `
                    <div>
                        <h4 class="font-medium text-gray-800">${person.name}</h4>
                        <p class="text-sm text-gray-600">è·ä½ï¼š${person.role}</p>
                        ${person.phone ? `<p class="text-sm text-gray-600">é›»è©±ï¼š${person.phone}</p>` : ''}
                        ${person.skills ? `<p class="text-sm text-gray-600">å°ˆé•·ï¼š${person.skills}</p>` : ''}
                    </div>
                    <button onclick="deletePersonnel(${index})" class="text-red-500 hover:text-red-700 px-3 py-2 rounded hover:bg-red-50 transition-colors cursor-pointer border border-red-300 hover:border-red-500">ğŸ—‘ï¸</button>
                `;
                container.appendChild(div);
            });
        }

        function deleteMaterial(index) {
            console.log('Delete material called with index:', index);
            // ç›´æ¥åˆªé™¤ï¼Œä¸ä½¿ç”¨ confirm
            materials.splice(index, 1);
            localStorage.setItem('farmMaterials', JSON.stringify(materials));
            displayMaterialsManagement();
            updateStats();
            showNotification('è³‡æå·²åˆªé™¤', 'info');
        }

        function deletePersonnel(index) {
            console.log('Delete personnel called with index:', index);
            // ç›´æ¥åˆªé™¤ï¼Œä¸ä½¿ç”¨ confirm
            personnel.splice(index, 1);
            localStorage.setItem('farmPersonnel', JSON.stringify(personnel));
            displayPersonnelManagement();
            updateStats();
            showNotification('äººå“¡å·²åˆªé™¤', 'info');
        }

        function deleteLogEntry(logId) {
            // ç›´æ¥åˆªé™¤ï¼Œä¸ä½¿ç”¨ confirm
            const index = logEntries.findIndex(log => log.id === logId);
            if (index !== -1) {
                const logToDelete = logEntries[index];
                
                // å›å¾©åº«å­˜
                if (logToDelete.materials && logToDelete.materials.length > 0) {
                    restoreMaterialStock(logToDelete.materials);
                }
                
                logEntries.splice(index, 1);
                localStorage.setItem('farmLogEntries', JSON.stringify(logEntries));
                closeEditModal();
                closeDayModal();
                displayCalendar();
                showNotification('è¨˜éŒ„å·²åˆªé™¤', 'info');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-medium z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Stock Management Functions

        function showStockReport() {
            const reportContent = document.getElementById('stockReportContent');
            
            if (materials.length === 0) {
                reportContent.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4">ğŸ“Š</div>
                        <h3 class="text-lg font-medium text-gray-600 mb-2">å°šç„¡åº«å­˜è³‡æ–™</h3>
                        <p class="text-gray-500">è«‹å…ˆæ–°å¢è³‡æå¾Œå†æŸ¥çœ‹åº«å­˜å ±è¡¨</p>
                    </div>
                `;
            } else {
                // åˆä½µåŒåè³‡æ
                const mergedMaterials = mergeMaterialsByName(materials);
                
                reportContent.innerHTML = `
                    <!-- çµ±è¨ˆæ‘˜è¦ -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center mb-6">
                        <div class="text-2xl font-bold text-blue-600">${mergedMaterials.length}</div>
                        <div class="text-sm text-blue-600">è³‡æå“é …</div>
                    </div>
                    
                    <!-- æœå°‹åŠŸèƒ½ -->
                    <div class="mb-6">
                        <div class="relative">
                            <input type="text" id="stockSearchInput" placeholder="è¼¸å…¥é—œéµå­—æœå°‹è³‡æå“é …..." 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-lg"
                                   oninput="filterStockItems()">
                            <div class="absolute right-3 top-3 text-gray-400">
                                ğŸ”
                            </div>
                        </div>
                    </div>
                    
                    <!-- è©³ç´°æ¸…å–® -->
                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                            <h4 class="font-medium text-gray-800">è©³ç´°åº«å­˜æ¸…å–® (é»é¸é …ç›®æŸ¥çœ‹é€²å‡ºè¨˜éŒ„)</h4>
                        </div>
                        <div id="stockItemsList" class="divide-y divide-gray-200">
                            ${mergedMaterials.map((material, index) => {
                                const stockValue = material.totalStock || 0;
                                const stockUnit = material.stockUnit || 'å€‹';
                                
                                // è¨ˆç®—æ­£ç¢ºçš„ç“¶è£åº«å­˜é¡¯ç¤º
                                let stockDisplayText = `${stockValue.toFixed(1)} ${stockUnit}`;
                                if (material.stockUnit === 'ç“¶' && material.bottleCapacity) {
                                    let totalUnopenedBottles = 0;
                                    let totalOpenedMl = 0;
                                    
                                    material.batches.forEach(batch => {
                                        if (batch.bottleStock) {
                                            totalUnopenedBottles += batch.bottleStock.unopenedBottles || 0;
                                            totalOpenedMl += batch.bottleStock.openedBottleMl || 0;
                                        } else {
                                            // èˆŠè³‡æ–™æ²’æœ‰ bottleStockï¼Œè¦–ç‚ºå…¨éƒ¨æœªé–‹å°
                                            totalUnopenedBottles += batch.currentStock || 0;
                                        }
                                    });
                                    
                                    if (totalOpenedMl > 0) {
                                        stockDisplayText = `æœªé–‹å° ${totalUnopenedBottles} ç“¶ï¼Œé–‹å° ${Math.round(totalOpenedMl)} æ¯«å‡`;
                                    } else {
                                        stockDisplayText = `æœªé–‹å° ${totalUnopenedBottles} ç“¶`;
                                    }
                                }
                                
                                return `
                                    <div class="stock-item px-4 py-3 hover:bg-gray-50 cursor-pointer transition-colors" 
                                         data-name="${material.name.toLowerCase()}" 
                                         data-category="${material.category.toLowerCase()}"
                                         onclick="showMaterialInOutHistory('${material.name}'); closeStockReport();">
                                        <div class="flex justify-between items-center">
                                            <div class="flex-1">
                                                <div class="flex items-center space-x-2">
                                                    <h5 class="font-medium text-gray-800">${material.name}</h5>
                                                    <span class="text-xs text-purple-500 bg-purple-100 px-2 py-1 rounded">æŸ¥çœ‹é€²å‡ºè¨˜éŒ„</span>
                                                    ${material.batchCount > 1 ? `<span class="text-xs text-blue-500 bg-blue-100 px-2 py-1 rounded">${material.batchCount} æ‰¹æ¬¡</span>` : ''}
                                                </div>
                                                <p class="text-sm text-gray-600">${material.category}</p>
                                                ${material.remarks ? `<p class="text-xs text-gray-500 mt-1">${material.remarks}</p>` : ''}
                                            </div>
                                            <div class="text-right">
                                                <div class="text-lg font-medium text-green-600">
                                                    ${stockDisplayText}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('stockReportModal').classList.remove('hidden');
        }

        function filterStockItems() {
            const searchTerm = document.getElementById('stockSearchInput').value.toLowerCase();
            const stockItems = document.querySelectorAll('.stock-item');
            
            stockItems.forEach(item => {
                const name = item.getAttribute('data-name');
                const category = item.getAttribute('data-category');
                
                if (name.includes(searchTerm) || category.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function closeStockReport() {
            document.getElementById('stockReportModal').classList.add('hidden');
        }

        function showMaterialBatches(materialName) {
            const batches = materials.filter(m => m.name === materialName);
            
            document.getElementById('stockHistoryTitle').innerHTML = `
                <span class="mr-2">ğŸ“‹</span>${materialName} - æ‰¹æ¬¡ç®¡ç†
            `;
            
            const historyContent = document.getElementById('stockHistoryContent');
            
            if (batches.length === 0) {
                historyContent.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4">ğŸ“‹</div>
                        <h3 class="text-lg font-medium text-gray-600 mb-2">æ‰¾ä¸åˆ°æ­¤è³‡æ</h3>
                        <p class="text-gray-500">æ­¤è³‡æå¯èƒ½å·²è¢«åˆªé™¤</p>
                    </div>
                `;
            } else {
                // è¨ˆç®—ç¸½è¨ˆ
                const totalStock = batches.reduce((sum, batch) => sum + (batch.currentStock || 0), 0);
                
                historyContent.innerHTML = `
                    <!-- ç¸½è¨ˆæ‘˜è¦ -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-medium text-blue-800 mb-3">${materialName} - ç¸½è¨ˆ</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600">${totalStock.toFixed(1)}</div>
                                <div class="text-sm text-blue-600">${batches[0].stockUnit || 'å€‹'}</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600">${batches.length}</div>
                                <div class="text-sm text-green-600">æ‰¹æ¬¡æ•¸é‡</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ‰¹æ¬¡æ¸…å–® -->
                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                            <h4 class="font-medium text-gray-800">æ‰¹æ¬¡è©³ç´°è³‡æ–™ (${batches.length} å€‹æ‰¹æ¬¡)</h4>
                        </div>
                        <div class="divide-y divide-gray-200">
                            ${batches.map((batch, index) => {
                                const stockValue = batch.currentStock || 0;
                                const stockUnit = batch.stockUnit || 'å€‹';
                                const stockDate = batch.stockDate || '';
                                
                                return `
                                    <div class="px-4 py-3">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <div class="flex items-center space-x-2 mb-2">
                                                    <h5 class="font-medium text-gray-800">æ‰¹æ¬¡ #${index + 1}</h5>
                                                    ${stockDate ? `<span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">${stockDate}</span>` : ''}
                                                </div>
                                                <div class="text-sm">
                                                    <span class="text-gray-500">åº«å­˜ï¼š</span>
                                                    <span class="font-medium text-green-600">${stockValue.toFixed(1)} ${stockUnit}</span>
                                                </div>
                                                ${batch.remarks ? `<p class="text-xs text-gray-500 mt-2">å‚™è¨»ï¼š${batch.remarks}</p>` : ''}
                                            </div>
                                            <div class="flex space-x-2 ml-4">
                                                <button onclick="showStockHistory(${materials.indexOf(batch)}); closeStockHistory();" class="text-green-500 hover:text-green-700 text-xs px-2 py-1 rounded border border-green-300 hover:bg-green-50 transition-colors">
                                                    ğŸ“‹ è¨˜éŒ„
                                                </button>
                                                <button onclick="adjustStock(${materials.indexOf(batch)}); closeStockHistory();" class="text-blue-500 hover:text-blue-700 text-xs px-2 py-1 rounded border border-blue-300 hover:bg-blue-50 transition-colors">
                                                    ğŸ“¦ èª¿æ•´
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('stockHistoryModal').classList.remove('hidden');
        }

        function adjustStockByName(materialName) {
            const batches = materials.filter(m => m.name === materialName);
            if (batches.length === 0) return;
            
            // å¦‚æœåªæœ‰ä¸€å€‹æ‰¹æ¬¡ï¼Œç›´æ¥èª¿æ•´
            if (batches.length === 1) {
                const index = materials.indexOf(batches[0]);
                adjustStock(index);
                return;
            }
            
            // å¤šå€‹æ‰¹æ¬¡æ™‚ï¼Œå…ˆé¡¯ç¤ºæ‰¹æ¬¡é¸æ“‡
            showMaterialBatches(materialName);
        }

        function deleteMaterialByName(materialName) {
            const batches = materials.filter(m => m.name === materialName);
            if (batches.length === 0) return;
            
            // åˆªé™¤æ‰€æœ‰åŒåæ‰¹æ¬¡
            for (let i = materials.length - 1; i >= 0; i--) {
                if (materials[i].name === materialName) {
                    materials.splice(i, 1);
                }
            }
            
            localStorage.setItem('farmMaterials', JSON.stringify(materials));
            displayMaterialsManagement();
            updateStats();
            showNotification(`å·²åˆªé™¤ ${materialName} çš„æ‰€æœ‰æ‰¹æ¬¡ (${batches.length} å€‹æ‰¹æ¬¡)`, 'info');
        }

        let adjustingMaterialIndex = null;
        let viewingMaterialIndex = null;

        function showStockHistory(materialIndex) {
            viewingMaterialIndex = materialIndex;
            const material = materials[materialIndex];
            
            document.getElementById('stockHistoryTitle').innerHTML = `
                <span class="mr-2">ğŸ“‹</span>${material.name} - åº«å­˜é€²å‡ºè¨˜éŒ„
            `;
            
            const historyContent = document.getElementById('stockHistoryContent');
            const stockHistory = material.stockHistory || [];
            
            if (stockHistory.length === 0) {
                historyContent.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4">ğŸ“‹</div>
                        <h3 class="text-lg font-medium text-gray-600 mb-2">å°šç„¡é€²å‡ºè¨˜éŒ„</h3>
                        <p class="text-gray-500">æ­¤è³‡æé‚„æ²’æœ‰ä»»ä½•åº«å­˜ç•°å‹•è¨˜éŒ„</p>
                    </div>
                `;
            } else {
                // é¡¯ç¤ºç›®å‰åº«å­˜ç‹€æ…‹
                const currentStock = material.currentStock || 0;
                const stockUnit = material.stockUnit || 'å€‹';
                const unitPrice = material.unitPrice || 0;
                const stockDate = material.stockDate || '';
                
                historyContent.innerHTML = `
                    <!-- ç›®å‰åº«å­˜ç‹€æ…‹ -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-medium text-blue-800 mb-3">ç›®å‰åº«å­˜ç‹€æ…‹</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600">${currentStock.toFixed(1)}</div>
                                <div class="text-sm text-blue-600">${stockUnit}</div>
                            </div>
                            ${unitPrice > 0 ? `
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600">$${unitPrice.toFixed(1)}</div>
                                    <div class="text-sm text-green-600">å–®åƒ¹</div>
                                </div>
                            ` : ''}
                            ${stockDate ? `
                                <div class="text-center">
                                    <div class="text-lg font-medium text-gray-600">${stockDate}</div>
                                    <div class="text-sm text-gray-600">å…¥åº«æ—¥æœŸ</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- é€²å‡ºè¨˜éŒ„ -->
                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                            <h4 class="font-medium text-gray-800">è©³ç´°é€²å‡ºè¨˜éŒ„</h4>
                        </div>
                        <div class="divide-y divide-gray-200">
                            ${stockHistory.slice().reverse().map(record => {
                                const recordDate = new Date(record.date);
                                const dateStr = recordDate.toLocaleDateString('zh-TW');
                                const timeStr = recordDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                                
                                let typeColor = 'text-gray-600 bg-gray-100';
                                let typeIcon = 'ğŸ“';
                                let typeText = record.reason || 'ç•°å‹•';
                                
                                if (record.type === 'initial') {
                                    typeColor = 'text-blue-600 bg-blue-100';
                                    typeIcon = 'ğŸ“¦';
                                    typeText = 'åˆå§‹åº«å­˜';
                                } else if (record.type === 'usage') {
                                    typeColor = 'text-red-600 bg-red-100';
                                    typeIcon = 'ğŸ“¤';
                                    typeText = 'ä½¿ç”¨';
                                } else if (record.type === 'add') {
                                    typeColor = 'text-green-600 bg-green-100';
                                    typeIcon = 'ğŸ“¥';
                                    typeText = 'å¢åŠ ';
                                } else if (record.type === 'subtract') {
                                    typeColor = 'text-orange-600 bg-orange-100';
                                    typeIcon = 'ğŸ“¤';
                                    typeText = 'æ¸›å°‘';
                                } else if (record.type === 'set') {
                                    typeColor = 'text-purple-600 bg-purple-100';
                                    typeIcon = 'âš™ï¸';
                                    typeText = 'è¨­å®š';
                                } else if (record.type === 'restore') {
                                    typeColor = 'text-indigo-600 bg-indigo-100';
                                    typeIcon = 'ğŸ”„';
                                    typeText = 'å›å¾©';
                                }
                                
                                const amountText = record.amount > 0 ? `+${record.amount}` : record.amount;
                                const amountColor = record.amount > 0 ? 'text-green-600' : 'text-red-600';
                                
                                return `
                                    <div class="px-4 py-3">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <div class="flex items-center space-x-2 mb-2">
                                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${typeColor}">
                                                        ${typeIcon} ${typeText}
                                                    </span>
                                                    <span class="text-sm text-gray-500">${dateStr} ${timeStr}</span>
                                                </div>
                                                <div class="text-sm text-gray-600 mb-1">
                                                    <span class="font-medium ${amountColor}">${amountText} ${stockUnit}</span>
                                                    â†’ åº«å­˜ï¼š${record.newStock} ${stockUnit}
                                                </div>
                                                ${record.note ? `<p class="text-xs text-gray-500">${record.note}</p>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('stockHistoryModal').classList.remove('hidden');
        }

        function closeStockHistory() {
            document.getElementById('stockHistoryModal').classList.add('hidden');
            viewingMaterialIndex = null;
        }

        function adjustStockFromHistory() {
            if (viewingMaterialIndex !== null) {
                closeStockHistory();
                adjustStock(viewingMaterialIndex);
            }
        }

        function adjustStock(materialIndex) {
            adjustingMaterialIndex = materialIndex;
            const material = materials[materialIndex];
            
            document.getElementById('adjustMaterialName').value = material.name;
            document.getElementById('currentStock').value = `${material.currentStock || 0} ${material.stockUnit || 'å€‹'}`;
            document.getElementById('adjustAmount').value = '';
            document.getElementById('adjustNote').value = '';
            document.getElementById('adjustType').value = 'add';
            document.getElementById('adjustReason').value = 'é€²è²¨';
            
            // Setup form submission
            document.getElementById('stockAdjustForm').onsubmit = handleStockAdjustment;
            
            document.getElementById('stockAdjustModal').classList.remove('hidden');
        }

        function closeStockAdjust() {
            document.getElementById('stockAdjustModal').classList.add('hidden');
            adjustingMaterialIndex = null;
        }

        function showMaterialInOutHistory(materialName) {
            document.getElementById('stockHistoryTitle').innerHTML = `
                <span class="mr-2">ğŸ“Š</span>${materialName} - é€²å‡ºè¨˜éŒ„
            `;
            
            const historyContent = document.getElementById('stockHistoryContent');
            
            // ç²å–æ‰€æœ‰åŒåè³‡æçš„æ‰¹æ¬¡
            const batches = materials.filter(m => m.name === materialName);
            
            // æ”¶é›†æ‰€æœ‰å…¥åº«è¨˜éŒ„
            const inRecords = [];
            batches.forEach(batch => {
                if (batch.stockHistory) {
                    batch.stockHistory.forEach(record => {
                        if (record.type === 'initial' || record.type === 'add' || record.type === 'restore') {
                            inRecords.push({
                                ...record,
                                batchId: batch.id,
                                stockUnit: batch.stockUnit
                            });
                        }
                    });
                }
            });
            
            // å¾å·¥ä½œæ—¥èªŒä¸­æ‰¾å‡ºä½¿ç”¨æ­¤è³‡æçš„è¨˜éŒ„
            const outRecords = [];
            logEntries.forEach(log => {
                if (log.materials && log.materials.length > 0) {
                    log.materials.forEach(material => {
                        if (material.name === materialName) {
                            outRecords.push({
                                date: log.date + 'T00:00:00.000Z',
                                type: 'usage',
                                workType: log.workType,
                                location: log.location,
                                crop: log.crop,
                                quantity: material.quantity,
                                unit: material.unit,
                                dilution: material.dilution,
                                totalMl: material.totalMl,
                                totalLiters: material.totalLiters,
                                note: `${log.workType} - ${material.quantity} ${material.unit}${material.dilution ? ` (ç¨€é‡‹${material.dilution}å€)` : ''}`
                            });
                        }
                    });
                }
            });
            
            // è¨ˆç®—çµ±è¨ˆ - é‡å°ç“¶è£è³‡æç‰¹æ®Šè™•ç†
            const stockUnit = batches.length > 0 ? batches[0].stockUnit : 'å€‹';
            let currentStockDisplay = '';
            
            if (stockUnit === 'ç“¶' && batches.length > 0 && batches[0].bottleCapacity) {
                // ç“¶è£è³‡æï¼šè¨ˆç®—å¯¦éš›ç“¶æ•¸å’Œé–‹å°æ¯«å‡æ•¸
                let totalUnopenedBottles = 0;
                let totalOpenedMl = 0;
                
                batches.forEach(batch => {
                    if (batch.bottleStock) {
                        totalUnopenedBottles += batch.bottleStock.unopenedBottles || 0;
                        totalOpenedMl += batch.bottleStock.openedBottleMl || 0;
                    } else {
                        // èˆŠè³‡æ–™æ²’æœ‰ bottleStockï¼Œè¦–ç‚ºå…¨éƒ¨æœªé–‹å°
                        totalUnopenedBottles += batch.currentStock || 0;
                    }
                });
                
                if (totalOpenedMl > 0) {
                    currentStockDisplay = `æœªé–‹å° ${totalUnopenedBottles} ç“¶ï¼Œé–‹å° ${Math.round(totalOpenedMl)} æ¯«å‡`;
                } else {
                    currentStockDisplay = `æœªé–‹å° ${totalUnopenedBottles} ç“¶`;
                }
            } else {
                // ä¸€èˆ¬è³‡æï¼šç›´æ¥è¨ˆç®—ç¸½åº«å­˜
                const totalCurrentStock = batches.reduce((sum, batch) => sum + (batch.currentStock || 0), 0);
                currentStockDisplay = `${totalCurrentStock.toFixed(1)} ${stockUnit}`;
            }
            
            historyContent.innerHTML = `
                <!-- çµ±è¨ˆæ‘˜è¦ -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium text-blue-800 mb-3">${materialName} - é€²å‡ºçµ±è¨ˆ</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${inRecords.length}</div>
                            <div class="text-sm text-green-600">å…¥åº«æ¬¡æ•¸</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-red-600">${outRecords.length}</div>
                            <div class="text-sm text-red-600">ä½¿ç”¨æ¬¡æ•¸</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-bold text-blue-600">${currentStockDisplay}</div>
                            <div class="text-sm text-blue-600">ç›®å‰åº«å­˜</div>
                        </div>
                    </div>
                </div>
                
                <!-- å·¦å³åˆ†æ¬„é¡¯ç¤º -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- å·¦æ¬„ï¼šå…¥åº«è¨˜éŒ„ -->
                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <div class="bg-green-50 px-4 py-3 border-b border-green-200">
                            <h4 class="font-medium text-green-800 flex items-center">
                                <span class="mr-2">ğŸ“¥</span>å…¥åº«è¨˜éŒ„ (${inRecords.length} ç­†)
                            </h4>
                        </div>
                        <div class="max-h-96 overflow-y-auto">
                            ${inRecords.length === 0 ? `
                                <div class="text-center py-8 text-gray-500">
                                    <div class="text-4xl mb-2">ğŸ“¥</div>
                                    <p>å°šç„¡å…¥åº«è¨˜éŒ„</p>
                                </div>
                            ` : `
                                <div class="divide-y divide-gray-200">
                                    ${inRecords.slice().reverse().map(record => {
                                        const recordDate = new Date(record.date);
                                        const dateStr = recordDate.toLocaleDateString('zh-TW');
                                        const timeStr = recordDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                                        
                                        let typeColor = 'text-green-600 bg-green-100';
                                        let typeIcon = 'ğŸ“¥';
                                        let typeText = 'å…¥åº«';
                                        
                                        if (record.type === 'initial') {
                                            typeIcon = 'ğŸ“¦';
                                            typeText = 'åˆå§‹åº«å­˜';
                                        } else if (record.type === 'add') {
                                            typeIcon = 'ğŸ“¥';
                                            typeText = 'å¢åŠ åº«å­˜';
                                        } else if (record.type === 'restore') {
                                            typeColor = 'text-indigo-600 bg-indigo-100';
                                            typeIcon = 'ğŸ”„';
                                            typeText = 'å›å¾©åº«å­˜';
                                        }
                                        
                                        return `
                                            <div class="px-4 py-3">
                                                <div class="flex items-center space-x-2 mb-2">
                                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${typeColor}">
                                                        ${typeIcon} ${typeText}
                                                    </span>
                                                    <span class="text-sm text-gray-500">${dateStr} ${timeStr}</span>
                                                </div>
                                                <div class="text-sm text-gray-600 mb-1">
                                                    <span class="font-medium text-green-600">+${Math.abs(record.amount || 0)} ${record.stockUnit || stockUnit}</span>
                                                    â†’ åº«å­˜ï¼š${record.newStock || 0} ${record.stockUnit || stockUnit}
                                                </div>
                                                ${record.note ? `<p class="text-xs text-gray-500">${record.note}</p>` : ''}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- å³æ¬„ï¼šä½¿ç”¨è¨˜éŒ„ -->
                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <div class="bg-red-50 px-4 py-3 border-b border-red-200">
                            <h4 class="font-medium text-red-800 flex items-center">
                                <span class="mr-2">ğŸ“¤</span>ä½¿ç”¨è¨˜éŒ„ (${outRecords.length} ç­†)
                            </h4>
                        </div>
                        <div class="max-h-96 overflow-y-auto">
                            ${outRecords.length === 0 ? `
                                <div class="text-center py-8 text-gray-500">
                                    <div class="text-4xl mb-2">ğŸ“¤</div>
                                    <p>å°šç„¡ä½¿ç”¨è¨˜éŒ„</p>
                                </div>
                            ` : `
                                <div class="divide-y divide-gray-200">
                                    ${outRecords.slice().reverse().map(record => {
                                        const recordDate = new Date(record.date);
                                        const dateStr = recordDate.toLocaleDateString('zh-TW');
                                        
                                        const workTypeColor = WORK_TYPE_COLORS[record.workType] || 'text-gray-700 bg-gray-50 border-gray-200';
                                        
                                        let dilutionText = record.dilution ? ` (ç¨€é‡‹ ${record.dilution} å€)` : '';
                                        let totalText = record.totalMl && record.totalLiters ? 
                                            ` â†’ ç¸½ç”¨é‡ï¼š${record.totalMl} æ¯«å‡ (${record.totalLiters} å…¬å‡)` : '';
                                        
                                        return `
                                            <div class="px-4 py-3">
                                                <div class="flex items-center space-x-2 mb-2">
                                                    <span class="px-2 py-1 rounded-full text-xs font-medium border ${workTypeColor}">
                                                        ${record.workType}
                                                    </span>
                                                    <span class="text-sm text-gray-500">${dateStr}</span>
                                                </div>
                                                <div class="text-sm text-gray-600 mb-1">
                                                    <span class="font-medium text-red-600">-${record.quantity} ${record.unit}</span>${dilutionText}${totalText}
                                                </div>
                                                ${record.location ? `<p class="text-xs text-gray-500">åœ°é»ï¼š${record.location}</p>` : ''}
                                                ${record.crop ? `<p class="text-xs text-gray-500">ä½œç‰©ï¼š${record.crop}</p>` : ''}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('stockHistoryModal').classList.remove('hidden');
        }

        function showMaterialUsageHistory(materialName) {
            // é‡æ–°å°å‘åˆ°æ–°çš„é€²å‡ºè¨˜éŒ„åŠŸèƒ½
            showMaterialInOutHistory(materialName);
        }

        function handleStockAdjustment(e) {
            e.preventDefault();
            
            if (adjustingMaterialIndex === null) return;
            
            const material = materials[adjustingMaterialIndex];
            const adjustType = document.getElementById('adjustType').value;
            const adjustAmount = parseFloat(document.getElementById('adjustAmount').value);
            const adjustReason = document.getElementById('adjustReason').value;
            const adjustNote = document.getElementById('adjustNote').value;
            
            if (isNaN(adjustAmount) || adjustAmount <= 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„èª¿æ•´æ•¸é‡');
                return;
            }
            
            let newStock = material.currentStock || 0;
            let changeAmount = 0;
            
            switch (adjustType) {
                case 'add':
                    newStock += adjustAmount;
                    changeAmount = adjustAmount;
                    break;
                case 'subtract':
                    newStock -= adjustAmount;
                    changeAmount = -adjustAmount;
                    break;
                case 'set':
                    changeAmount = adjustAmount - newStock;
                    newStock = adjustAmount;
                    break;
            }
            
            if (newStock < 0) {
                alert('åº«å­˜ä¸èƒ½ç‚ºè² æ•¸');
                return;
            }
            
            // æ›´æ–°åº«å­˜
            material.currentStock = newStock;
            
            // è¨˜éŒ„åº«å­˜ç•°å‹•
            if (!material.stockHistory) {
                material.stockHistory = [];
            }
            
            material.stockHistory.push({
                date: new Date().toISOString(),
                type: adjustType,
                amount: changeAmount,
                newStock: newStock,
                reason: adjustReason,
                note: adjustNote
            });
            
            // å„²å­˜åˆ° localStorage
            localStorage.setItem('farmMaterials', JSON.stringify(materials));
            
            // æ›´æ–°é¡¯ç¤º
            displayMaterialsManagement();
            closeStockAdjust();
            
            showNotification(`${material.name} åº«å­˜å·²èª¿æ•´ç‚º ${newStock} ${material.stockUnit}`, 'success');
        }

        // Export and Import Functions
        function exportData() {
            // Create separate CSV files for different data types
            const now = new Date();
            const dateStr = now.getFullYear() + 
                          String(now.getMonth() + 1).padStart(2, '0') + 
                          String(now.getDate()).padStart(2, '0');
            const timeStr = String(now.getHours()).padStart(2, '0') + 
                          String(now.getMinutes()).padStart(2, '0');

            // Export Work Logs CSV
            if (logEntries.length > 0) {
                const logsCsv = convertLogsToCSV(logEntries);
                downloadCSV(logsCsv, `å·¥ä½œæ—¥èªŒ_${dateStr}_${timeStr}.csv`);
            }

            // Export Materials CSV
            if (materials.length > 0) {
                const materialsCsv = convertMaterialsToCSV(materials);
                downloadCSV(materialsCsv, `è³‡ææ¸…å–®_${dateStr}_${timeStr}.csv`);
            }

            // Export Personnel CSV
            if (personnel.length > 0) {
                const personnelCsv = convertPersonnelToCSV(personnel);
                downloadCSV(personnelCsv, `äººå“¡æ¸…å–®_${dateStr}_${timeStr}.csv`);
            }

            showNotification(`å·²åŒ¯å‡º ${logEntries.length} ç­†å·¥ä½œè¨˜éŒ„ã€${materials.length} é …è³‡æã€${personnel.length} ä½äººå“¡è³‡æ–™`, 'success');
        }

        function convertLogsToCSV(logs) {
            const headers = [
                'æ—¥æœŸ', 'åœ°é»', 'å¤©æ°£', 'ä½œæ¥­é¡å‹', 'ä½œç‰©', 'ä½œæ¥­è©³æƒ…', 'ç”¢é‡è¨˜éŒ„', 
                'è§€å¯Ÿè¨˜éŒ„', 'å‚™è¨»', 'ä½¿ç”¨è³‡æ', 'å·¥ä½œäººå“¡', 'ç¸½å·¥æ™‚'
            ];

            const csvRows = [headers.join(',')];

            logs.forEach(log => {
                // Process materials
                const materialsText = log.materials ? log.materials.map(m => {
                    let dilution = m.dilution ? `(ç¨€é‡‹${m.dilution}å€)` : '';
                    let total = m.totalMl ? `â†’${m.totalMl}æ¯«å‡` : '';
                    return `${m.name}:${m.quantity}${m.unit}${dilution}${total}`;
                }).join(';') : '';

                // Process workers
                const workersText = log.workers ? log.workers.map(w => 
                    `${w.name}:${w.hours}å°æ™‚`
                ).join(';') : '';

                const totalHours = log.workers ? log.workers.reduce((sum, w) => sum + w.hours, 0) : 0;

                const row = [
                    log.date || '',
                    escapeCSV(log.location || ''),
                    log.weather || '',
                    log.workType || '',
                    escapeCSV(log.crop || ''),
                    escapeCSV(log.details || ''),
                    escapeCSV(log.yield || ''),
                    escapeCSV(log.observations || ''),
                    escapeCSV(log.notes || ''),
                    escapeCSV(materialsText),
                    escapeCSV(workersText),
                    totalHours
                ];

                csvRows.push(row.join(','));
            });

            return csvRows.join('\n');
        }

        function convertMaterialsToCSV(materials) {
            const headers = ['è³‡æåç¨±', 'é¡åˆ¥', 'å‚™è¨»'];
            const csvRows = [headers.join(',')];

            materials.forEach(material => {
                const row = [
                    escapeCSV(material.name || ''),
                    escapeCSV(material.category || ''),
                    escapeCSV(material.remarks || '')
                ];
                csvRows.push(row.join(','));
            });

            return csvRows.join('\n');
        }

        function convertPersonnelToCSV(personnel) {
            const headers = ['å§“å', 'è·ä½', 'è¯çµ¡é›»è©±', 'å°ˆé•·'];
            const csvRows = [headers.join(',')];

            personnel.forEach(person => {
                const row = [
                    escapeCSV(person.name || ''),
                    escapeCSV(person.role || ''),
                    escapeCSV(person.phone || ''),
                    escapeCSV(person.skills || '')
                ];
                csvRows.push(row.join(','));
            });

            return csvRows.join('\n');
        }

        function escapeCSV(text) {
            if (typeof text !== 'string') return text;
            // Escape quotes and wrap in quotes if contains comma, quote, or newline
            if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                return '"' + text.replace(/"/g, '""') + '"';
            }
            return text;
        }

        function downloadCSV(csvContent, filename) {
            try {
                // Add BOM for proper UTF-8 encoding in Excel
                const BOM = '\uFEFF';
                const fullContent = BOM + csvContent;
                
                // Create blob with proper MIME type
                const blob = new Blob([fullContent], { 
                    type: 'text/csv;charset=utf-8;' 
                });
                
                // Check for IE/Edge legacy support
                if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                    window.navigator.msSaveOrOpenBlob(blob, filename);
                    showNotification(`æª”æ¡ˆå·²ä¸‹è¼‰ï¼š${filename}`, 'success');
                    return;
                }
                
                // Modern browsers
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                // Set up the download link
                link.href = url;
                link.download = filename;
                link.style.position = 'fixed';
                link.style.left = '-9999px';
                link.setAttribute('target', '_blank');
                
                // Add to DOM and trigger download
                document.body.appendChild(link);
                
                // Force download with multiple methods
                try {
                    link.click();
                } catch (clickError) {
                    // Fallback click method
                    const event = new MouseEvent('click', {
                        view: window,
                        bubbles: true,
                        cancelable: true
                    });
                    link.dispatchEvent(event);
                }
                
                // Clean up after a short delay
                setTimeout(() => {
                    try {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    } catch (cleanupError) {
                        console.log('Cleanup error:', cleanupError);
                    }
                }, 500);
                
                showNotification(`æª”æ¡ˆå·²æº–å‚™ä¸‹è¼‰ï¼š${filename}`, 'success');
                
            } catch (error) {
                console.error('Download error:', error);
                
                // Ultimate fallback: open in new window
                try {
                    const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent('\uFEFF' + csvContent);
                    const newWindow = window.open();
                    
                    if (newWindow) {
                        newWindow.document.write(`
                            <html>
                                <head><title>ä¸‹è¼‰ ${filename}</title></head>
                                <body>
                                    <h3>è«‹æ‰‹å‹•å„²å­˜æ­¤æª”æ¡ˆ</h3>
                                    <p>æª”æ¡ˆåç¨±ï¼š${filename}</p>
                                    <p>è«‹æŒ‰ Ctrl+S (Windows) æˆ– Cmd+S (Mac) å„²å­˜æª”æ¡ˆ</p>
                                    <hr>
                                    <pre style="white-space: pre-wrap; font-family: monospace;">${csvContent}</pre>
                                </body>
                            </html>
                        `);
                        newWindow.document.close();
                        showNotification('è«‹åœ¨æ–°è¦–çª—ä¸­æ‰‹å‹•å„²å­˜æª”æ¡ˆ (Ctrl+S)', 'info');
                    } else {
                        // Last resort: show alert with instructions
                        alert(`ä¸‹è¼‰åŠŸèƒ½è¢«ç€è¦½å™¨é˜»æ“‹ã€‚\n\nè«‹å˜—è©¦ä»¥ä¸‹æ–¹æ³•ï¼š\n1. å…è¨±æ­¤ç¶²ç«™çš„å½ˆå‡ºè¦–çª—\n2. æª¢æŸ¥ç€è¦½å™¨çš„ä¸‹è¼‰è¨­å®š\n3. å˜—è©¦ä½¿ç”¨å…¶ä»–ç€è¦½å™¨\n\næª”æ¡ˆåç¨±ï¼š${filename}`);
                        showNotification('ä¸‹è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š', 'error');
                    }
                } catch (fallbackError) {
                    console.error('Fallback error:', fallbackError);
                    alert(`åŒ¯å‡ºåŠŸèƒ½æš«æ™‚ç„¡æ³•ä½¿ç”¨ã€‚\n\nå¯èƒ½åŸå› ï¼š\n1. ç€è¦½å™¨å®‰å…¨è¨­å®šéæ–¼åš´æ ¼\n2. å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹\n\nè«‹å˜—è©¦ä½¿ç”¨å…¶ä»–ç€è¦½å™¨æˆ–èª¿æ•´å®‰å…¨è¨­å®šã€‚`);
                    showNotification('åŒ¯å‡ºå¤±æ•—', 'error');
                }
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showNotification('è«‹é¸æ“‡ CSV æ ¼å¼çš„æª”æ¡ˆ', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const fileName = file.name.toLowerCase();
                    
                    // Determine file type based on filename
                    let importedData = null;
                    let dataType = '';
                    
                    if (fileName.includes('å·¥ä½œæ—¥èªŒ') || fileName.includes('work') || fileName.includes('log')) {
                        importedData = parseLogsCSV(csvContent);
                        dataType = 'logs';
                    } else if (fileName.includes('è³‡æ') || fileName.includes('material')) {
                        importedData = parseMaterialsCSV(csvContent);
                        dataType = 'materials';
                    } else if (fileName.includes('äººå“¡') || fileName.includes('personnel') || fileName.includes('staff')) {
                        importedData = parsePersonnelCSV(csvContent);
                        dataType = 'personnel';
                    } else {
                        // Try to auto-detect based on headers
                        const lines = csvContent.split('\n');
                        if (lines.length > 0) {
                            const headers = lines[0].toLowerCase();
                            if (headers.includes('æ—¥æœŸ') && headers.includes('ä½œæ¥­é¡å‹')) {
                                importedData = parseLogsCSV(csvContent);
                                dataType = 'logs';
                            } else if (headers.includes('è³‡æåç¨±') || headers.includes('é¡åˆ¥')) {
                                importedData = parseMaterialsCSV(csvContent);
                                dataType = 'materials';
                            } else if (headers.includes('å§“å') && headers.includes('è·ä½')) {
                                importedData = parsePersonnelCSV(csvContent);
                                dataType = 'personnel';
                            } else {
                                throw new Error('ç„¡æ³•è­˜åˆ¥CSVæª”æ¡ˆé¡å‹ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º');
                            }
                        }
                    }

                    if (!importedData || importedData.length === 0) {
                        throw new Error('CSVæª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆè³‡æ–™');
                    }

                    // Show confirmation dialog
                    const confirmMessage = `å³å°‡åŒ¯å…¥ ${importedData.length} ç­†${getDataTypeName(dataType)}è³‡æ–™\n\nåŒ¯å…¥æ–¹å¼ï¼š\nç¢ºå®š = åˆä½µæ¨¡å¼ï¼ˆä¿ç•™ç¾æœ‰è³‡æ–™ï¼‰\nå–æ¶ˆ = è¦†è“‹æ¨¡å¼ï¼ˆæ¸…é™¤ç¾æœ‰è³‡æ–™ï¼‰`;
                    
                    const userChoice = confirm(confirmMessage);
                    
                    if (userChoice) {
                        // Merge mode
                        mergeCSVData(importedData, dataType);
                    } else {
                        const confirmOverwrite = confirm(`âš ï¸ è¦†è“‹æ¨¡å¼å°‡æœƒåˆªé™¤æ‰€æœ‰ç¾æœ‰çš„${getDataTypeName(dataType)}è³‡æ–™ï¼\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`);
                        if (confirmOverwrite) {
                            // Overwrite mode
                            overwriteCSVData(importedData, dataType);
                        }
                    }

                } catch (error) {
                    console.error('Import error:', error);
                    showNotification('åŒ¯å…¥å¤±æ•—ï¼š' + error.message, 'error');
                }
            };

            reader.readAsText(file, 'UTF-8');
            // Reset file input
            event.target.value = '';
        }

        function parseLogsCSV(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim());
            if (lines.length < 2) throw new Error('CSVæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º');

            const headers = parseCSVLine(lines[0]);
            const logs = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length < headers.length) continue;

                const log = {
                    id: Date.now() + Math.random(),
                    date: values[0] || '',
                    location: values[1] || '',
                    weather: values[2] || '',
                    workType: values[3] || '',
                    crop: values[4] || '',
                    details: values[5] || '',
                    yield: values[6] || '',
                    observations: values[7] || '',
                    notes: values[8] || '',
                    materials: parseMaterialsFromText(values[9] || ''),
                    workers: parseWorkersFromText(values[10] || ''),
                    timestamp: new Date().toISOString()
                };

                if (log.date && log.workType) {
                    logs.push(log);
                }
            }

            return logs;
        }

        function parseMaterialsCSV(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim());
            if (lines.length < 2) throw new Error('CSVæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º');

            const headers = parseCSVLine(lines[0]);
            const materials = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length < 2) continue;

                const material = {
                    id: Date.now() + Math.random(),
                    name: values[0] || '',
                    category: values[1] || '',
                    remarks: values[2] || ''
                };

                if (material.name && material.category) {
                    materials.push(material);
                }
            }

            return materials;
        }

        function parsePersonnelCSV(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim());
            if (lines.length < 2) throw new Error('CSVæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º');

            const headers = parseCSVLine(lines[0]);
            const personnel = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length < 2) continue;

                const person = {
                    id: Date.now() + Math.random(),
                    name: values[0] || '',
                    role: values[1] || '',
                    phone: values[2] || '',
                    skills: values[3] || ''
                };

                if (person.name && person.role) {
                    personnel.push(person);
                }
            }

            return personnel;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        function parseMaterialsFromText(text) {
            if (!text) return [];
            
            return text.split(';').map(item => {
                const parts = item.split(':');
                if (parts.length < 2) return null;
                
                const name = parts[0];
                const usageText = parts[1];
                
                // Parse quantity and unit
                const match = usageText.match(/^(\d+(?:\.\d+)?)(.*?)(\(ç¨€é‡‹(\d+)å€\))?(â†’(\d+)æ¯«å‡)?$/);
                if (!match) return null;
                
                return {
                    name: name,
                    quantity: parseFloat(match[1]),
                    unit: match[2] || 'æ¯«å‡',
                    dilution: match[4] ? parseFloat(match[4]) : null,
                    totalMl: match[6] || null
                };
            }).filter(item => item !== null);
        }

        function parseWorkersFromText(text) {
            if (!text) return [];
            
            return text.split(';').map(item => {
                const parts = item.split(':');
                if (parts.length < 2) return null;
                
                const name = parts[0];
                const hoursText = parts[1].replace('å°æ™‚', '');
                const hours = parseFloat(hoursText);
                
                if (isNaN(hours)) return null;
                
                return {
                    name: name,
                    hours: hours
                };
            }).filter(item => item !== null);
        }

        function getDataTypeName(dataType) {
            switch (dataType) {
                case 'logs': return 'å·¥ä½œè¨˜éŒ„';
                case 'materials': return 'è³‡æ';
                case 'personnel': return 'äººå“¡';
                default: return '';
            }
        }

        function mergeCSVData(importedData, dataType) {
            let addedCount = 0;

            switch (dataType) {
                case 'logs':
                    importedData.forEach(importedLog => {
                        const exists = logEntries.some(existingLog => 
                            existingLog.date === importedLog.date &&
                            existingLog.workType === importedLog.workType &&
                            existingLog.location === importedLog.location
                        );
                        
                        if (!exists) {
                            logEntries.push(importedLog);
                            addedCount++;
                        }
                    });
                    localStorage.setItem('farmLogEntries', JSON.stringify(logEntries));
                    break;

                case 'materials':
                    importedData.forEach(importedMaterial => {
                        const exists = materials.some(existingMaterial => 
                            existingMaterial.name === importedMaterial.name &&
                            existingMaterial.category === importedMaterial.category
                        );
                        
                        if (!exists) {
                            materials.push(importedMaterial);
                            addedCount++;
                        }
                    });
                    localStorage.setItem('farmMaterials', JSON.stringify(materials));
                    break;

                case 'personnel':
                    importedData.forEach(importedPerson => {
                        const exists = personnel.some(existingPerson => 
                            existingPerson.name === importedPerson.name &&
                            existingPerson.role === importedPerson.role
                        );
                        
                        if (!exists) {
                            personnel.push(importedPerson);
                            addedCount++;
                        }
                    });
                    localStorage.setItem('farmPersonnel', JSON.stringify(personnel));
                    break;
            }

            updateStats();
            displayCalendar();
            showNotification(`åˆä½µå®Œæˆï¼æ–°å¢äº† ${addedCount} ç­†${getDataTypeName(dataType)}`, 'success');
        }

        function overwriteCSVData(importedData, dataType) {
            switch (dataType) {
                case 'logs':
                    logEntries.length = 0;
                    logEntries.push(...importedData);
                    localStorage.setItem('farmLogEntries', JSON.stringify(logEntries));
                    break;

                case 'materials':
                    materials.length = 0;
                    materials.push(...importedData);
                    localStorage.setItem('farmMaterials', JSON.stringify(materials));
                    break;

                case 'personnel':
                    personnel.length = 0;
                    personnel.push(...importedData);
                    localStorage.setItem('farmPersonnel', JSON.stringify(personnel));
                    break;
            }

            updateStats();
            displayCalendar();
            showNotification(`è³‡æ–™å·²è¦†è“‹ï¼åŒ¯å…¥äº† ${importedData.length} ç­†${getDataTypeName(dataType)}`, 'success');
        }


    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'962f967c8540f1cc',t:'MTc1MzE1MjE3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
