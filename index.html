<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>農場管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        .fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .feature-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .calendar-day {
            min-height: 120px;
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
            background-color: #f8fafc;
            transform: scale(1.02);
        }
        
        .work-type-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin: 1px;
            display: inline-block;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .work-type-badge:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Main Cover Page -->
    <div id="coverPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-6xl w-full">
            <!-- Header -->
            <div class="text-center mb-12 fade-in">
                <div class="text-8xl mb-6">🍊</div>
                <h1 class="text-5xl md:text-6xl font-bold text-white mb-4">農場管理系統</h1>
                <p class="text-xl text-white/80 max-w-2xl mx-auto">
                    專業的農場作業記錄與資材管理平台，讓您的農場管理更加高效便利
                </p>
            </div>

            <!-- Navigation Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 fade-in">
                <!-- 新增工作日誌 -->
                <div class="feature-card rounded-2xl p-8 text-center card-hover cursor-pointer" onclick="showSection('workLog')">
                    <div class="text-5xl mb-4">📝</div>
                    <h3 class="text-xl font-semibold text-white mb-3">新增工作日誌</h3>
                    <p class="text-white/70 text-sm mb-4">記錄每日農場作業內容、天氣狀況及觀察心得</p>
                    <div class="bg-white/20 hover:bg-white/30 transition-colors rounded-lg py-2 px-4 text-white font-medium">
                        開始記錄 →
                    </div>
                </div>

                <!-- 新增資材及人員 -->
                <div class="feature-card rounded-2xl p-8 text-center card-hover cursor-pointer" onclick="showSection('addResources')">
                    <div class="text-5xl mb-4">➕</div>
                    <h3 class="text-xl font-semibold text-white mb-3">新增資材及人員</h3>
                    <p class="text-white/70 text-sm mb-4">建立資材庫存清單與人員資料庫</p>
                    <div class="bg-white/20 hover:bg-white/30 transition-colors rounded-lg py-2 px-4 text-white font-medium">
                        新增資料 →
                    </div>
                </div>

                <!-- 人員資材管理 -->
                <div class="feature-card rounded-2xl p-8 text-center card-hover cursor-pointer" onclick="showSection('management')">
                    <div class="text-5xl mb-4">👥</div>
                    <h3 class="text-xl font-semibold text-white mb-3">人員資材管理</h3>
                    <p class="text-white/70 text-sm mb-4">管理農場人員資訊與資材庫存狀況</p>
                    <div class="bg-white/20 hover:bg-white/30 transition-colors rounded-lg py-2 px-4 text-white font-medium">
                        進入管理 →
                    </div>
                </div>

                <!-- 所有工作日誌 -->
                <div class="feature-card rounded-2xl p-8 text-center card-hover cursor-pointer" onclick="showSection('allLogs')">
                    <div class="text-5xl mb-4">📊</div>
                    <h3 class="text-xl font-semibold text-white mb-3">所有工作日誌</h3>
                    <p class="text-white/70 text-sm mb-4">查看歷史記錄與統計分析</p>
                    <div class="bg-white/20 hover:bg-white/30 transition-colors rounded-lg py-2 px-4 text-white font-medium">
                        查看記錄 →
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6 fade-in">
                <div class="feature-card rounded-xl p-6 text-center">
                    <div class="text-3xl text-white font-bold" id="totalLogs">0</div>
                    <div class="text-white/70">總工作記錄</div>
                </div>
                <div class="feature-card rounded-xl p-6 text-center">
                    <div class="text-3xl text-white font-bold" id="totalMaterials">0</div>
                    <div class="text-white/70">資材種類</div>
                </div>
                <div class="feature-card rounded-xl p-6 text-center">
                    <div class="text-3xl text-white font-bold" id="totalPersonnel">0</div>
                    <div class="text-white/70">人員數量</div>
                </div>
            </div>

            <!-- Data Management -->
            <div class="mt-8 flex justify-center space-x-4 fade-in">
                <button onclick="exportData()" class="feature-card rounded-lg px-6 py-3 text-white hover:bg-white/10 transition-colors flex items-center">
                    <span class="mr-2">📤</span>匯出資料
                </button>
                <label class="feature-card rounded-lg px-6 py-3 text-white hover:bg-white/10 transition-colors flex items-center cursor-pointer">
                    <span class="mr-2">📥</span>匯入資料
                    <input type="file" id="importFile" accept=".csv" class="hidden" onchange="importData(event)">
                </label>
            </div>
        </div>
    </div>

    <!-- Work Log Section -->
    <div id="workLogSection" class="hidden min-h-screen bg-gradient-to-br from-green-50 to-blue-50">
        <div class="container mx-auto px-4 py-8 max-w-6xl">
            <!-- Back Button -->
            <button onclick="showSection('cover')" class="mb-6 bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg shadow-md transition-colors flex items-center">
                ← 返回首頁
            </button>

            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">📝 新增工作日誌</h1>
                <p class="text-gray-600">記錄您的農場日常作業與觀察</p>
            </div>

            <!-- Work Log Form -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border border-gray-100">
                <form id="farmLogForm" class="space-y-6">
                    <!-- Basic Information Row -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">日期</label>
                            <input type="date" id="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">地點</label>
                            <input type="text" id="location" placeholder="例：A區田地" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">天氣</label>
                            <select id="weather" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                                <option value="">選擇天氣</option>
                                <option value="晴天">☀️ 晴天</option>
                                <option value="多雲">⛅ 多雲</option>
                                <option value="陰天">☁️ 陰天</option>
                                <option value="小雨">🌦️ 小雨</option>
                                <option value="大雨">🌧️ 大雨</option>
                            </select>
                        </div>
                    </div>

                    <!-- Work Details Row -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">作業類型</label>
                            <div class="relative">
                                <input type="text" id="workType" placeholder="輸入或選擇作業類型..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" onfocus="showWorkTypeSuggestions()" oninput="filterWorkTypeSuggestions()">
                                <div id="workTypeSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-40 overflow-y-auto">
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectWorkType('整地')">🚜 整地</div>
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectWorkType('播種/育苗')">🌱 播種/育苗</div>
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectWorkType('施肥')">🌿 施肥</div>
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectWorkType('灌溉')">💧 灌溉</div>
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectWorkType('病蟲害防治')">🐛 病蟲害防治</div>
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectWorkType('除草')">🌾 除草</div>
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectWorkType('修剪/疏果')">✂️ 修剪/疏果</div>
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectWorkType('採收')">🥕 採收</div>
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectWorkType('維護')">🔧 維護</div>
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectWorkType('其他')">📋 其他</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">作物</label>
                            <input type="text" id="crop" placeholder="例：番茄、玉米" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        </div>
                    </div>

                    <!-- Material Usage Section -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">🧪</span>資材使用
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700 mb-2">資材名稱</label>
                                <input type="text" id="materialName" placeholder="輸入關鍵字搜尋資材..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                <div id="materialSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-40 overflow-y-auto"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">使用量</label>
                                <input type="number" id="materialQuantity" placeholder="數量" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">單位</label>
                                <select id="materialUnit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                    <option value="毫升">毫升</option>
                                    <option value="公升">公升</option>
                                    <option value="克">克</option>
                                    <option value="公斤">公斤</option>
                                    <option value="斤">斤</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">稀釋倍數</label>
                                <input type="number" id="dilutionRatio" placeholder="例：100" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 mb-4">
                            <button type="button" id="addMaterialBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                                <span class="mr-1">➕</span>添加資材
                            </button>
                        </div>
                        
                        <div id="materialsList" class="space-y-2"></div>
                    </div>

                    <!-- Work Personnel Section -->
                    <div class="bg-gray-50 rounded-lg p-4 mt-6">
                        <h3 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">👥</span>工作人員及工時
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700 mb-2">人員姓名</label>
                                <input type="text" id="workerName" placeholder="輸入關鍵字搜尋人員..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                                <div id="workerSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-40 overflow-y-auto"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">工作時數</label>
                                <input type="number" id="workHours" placeholder="小時" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                            </div>
                            <div class="flex items-end">
                                <button type="button" id="addWorkerBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center w-full justify-center">
                                    <span class="mr-1">➕</span>添加人員
                                </button>
                            </div>
                        </div>
                        
                        <div id="workersList" class="space-y-2"></div>
                    </div>

                    <!-- Details and Observations -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">作業詳情</label>
                            <textarea id="details" rows="3" placeholder="詳細描述作業內容..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all resize-none"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">產量記錄</label>
                            <input type="text" id="yield" placeholder="例：收穫 50 公斤番茄" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">觀察記錄</label>
                            <textarea id="observations" rows="3" placeholder="記錄作物生長狀況、病蟲害等..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all resize-none"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">備註</label>
                            <textarea id="notes" rows="3" placeholder="其他需要記錄的事項..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all resize-none"></textarea>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex justify-end">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-medium transition-colors flex items-center shadow-lg">
                            <span class="mr-2">💾</span>儲存記錄
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Resources Section -->
    <div id="addResourcesSection" class="hidden min-h-screen bg-gradient-to-br from-purple-50 to-pink-50">
        <div class="container mx-auto px-4 py-8 max-w-4xl">
            <button onclick="showSection('cover')" class="mb-6 bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg shadow-md transition-colors flex items-center">
                ← 返回首頁
            </button>

            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">➕ 新增資材及人員</h1>
                <p class="text-gray-600">建立您的資材庫存與人員資料庫</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Add Material -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">🧪</span>新增資材
                    </h2>
                    <form id="addMaterialForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">資材名稱</label>
                            <input type="text" id="newMaterialName" placeholder="例：有機肥料" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">類別</label>
                            <select id="materialCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                                <option value="肥料">肥料</option>
                                <option value="農藥">農藥</option>
                                <option value="種子">種子</option>
                                <option value="工具">工具</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">入庫數量</label>
                            <input type="number" id="initialStock" placeholder="0" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">庫存單位</label>
                            <select id="stockUnit" onchange="toggleCapacityField()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                                <option value="毫升">毫升</option>
                                <option value="公升">公升</option>
                                <option value="克">克</option>
                                <option value="公斤">公斤</option>
                                <option value="斤">斤</option>
                                <option value="瓶">瓶</option>
                                <option value="包">包</option>
                                <option value="個">個</option>
                            </select>
                        </div>
                        <div id="capacityField" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <span id="capacityLabel">每瓶容量</span>
                            </label>
                            <div class="flex space-x-2">
                                <input type="number" id="capacityAmount" placeholder="容量" step="0.1" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                                <select id="capacityUnit" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                                    <option value="毫升">毫升</option>
                                    <option value="公升">公升</option>
                                    <option value="克">克</option>
                                    <option value="公斤">公斤</option>
                                    <option value="斤">斤</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">入庫價錢</label>
                            <input type="number" id="purchasePrice" placeholder="0" step="0.01" onchange="calculateUnitPrice()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                        </div>
                        <div id="unitPriceDisplay" class="hidden bg-green-50 border border-green-200 rounded-lg p-3">
                            <div class="text-sm text-green-700">
                                <strong>單位售價：</strong><span id="unitPriceValue">0</span> 元
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">備註</label>
                            <input type="text" id="materialRemarks" placeholder="例：使用方法、注意事項" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                        </div>

                        <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg transition-colors">
                            新增資材
                        </button>
                    </form>
                </div>

                <!-- Add Personnel -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">👤</span>新增人員
                    </h2>
                    <form id="addPersonnelForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">姓名</label>
                            <input type="text" id="personnelName" placeholder="員工姓名" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">職位</label>
                            <select id="personnelRole" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                <option value="農場主">農場主</option>
                                <option value="農場經理">農場經理</option>
                                <option value="技術員">技術員</option>
                                <option value="工人">工人</option>
                                <option value="臨時工">臨時工</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">聯絡電話</label>
                            <input type="tel" id="personnelPhone" placeholder="聯絡電話" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">專長</label>
                            <input type="text" id="personnelSkills" placeholder="例：作物栽培、機械操作" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors">
                            新增人員
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Management Section -->
    <div id="managementSection" class="hidden min-h-screen bg-gradient-to-br from-orange-50 to-red-50">
        <div class="container mx-auto px-4 py-8 max-w-6xl">
            <button onclick="showSection('cover')" class="mb-6 bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg shadow-md transition-colors flex items-center">
                ← 返回首頁
            </button>

            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">👥 人員資材管理</h1>
                <p class="text-gray-600">管理農場人員資訊與資材庫存狀況</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Materials Management -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">🧪</span>資材管理
                    </h2>
                    <div id="managementMaterialsList" class="space-y-3">
                        <!-- Materials will be loaded here -->
                    </div>
                </div>

                <!-- Personnel Management -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">👥</span>人員管理
                    </h2>
                    <div id="personnelList" class="space-y-3">
                        <!-- Personnel will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- All Logs Section with Calendar -->
    <div id="allLogsSection" class="hidden min-h-screen bg-gradient-to-br from-green-50 to-blue-50">
        <div class="container mx-auto px-4 py-8 max-w-7xl">
            <button onclick="showSection('cover')" class="mb-6 bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg shadow-md transition-colors flex items-center">
                ← 返回首頁
            </button>

            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">📊 所有工作日誌</h1>
                <p class="text-gray-600">查看歷史記錄與統計分析</p>
            </div>

            <!-- Calendar Navigation -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="changeMonth(-1)" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        ← 上個月
                    </button>
                    <h2 id="currentMonth" class="text-2xl font-bold text-gray-800"></h2>
                    <button onclick="changeMonth(1)" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        下個月 →
                    </button>
                </div>

                <!-- Calendar Grid -->
                <div class="grid grid-cols-7 gap-1">
                    <!-- Day Headers -->
                    <div class="text-center font-semibold text-gray-600 py-2">日</div>
                    <div class="text-center font-semibold text-gray-600 py-2">一</div>
                    <div class="text-center font-semibold text-gray-600 py-2">二</div>
                    <div class="text-center font-semibold text-gray-600 py-2">三</div>
                    <div class="text-center font-semibold text-gray-600 py-2">四</div>
                    <div class="text-center font-semibold text-gray-600 py-2">五</div>
                    <div class="text-center font-semibold text-gray-600 py-2">六</div>
                    
                    <!-- Calendar Days -->
                    <div id="calendarDays" class="contents"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Details Modal -->
    <div id="dayDetailsModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="modalDate" class="text-2xl font-bold text-gray-800"></h2>
                    <button onclick="closeDayModal()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                </div>
                <div id="dayLogsList" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- Edit Work Log Modal -->
    <div id="editWorkLogModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">編輯工作日誌</h2>
                    <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                </div>
                
                <form id="editWorkLogForm" class="space-y-6">
                    <!-- Basic Information Row -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">日期</label>
                            <input type="date" id="editDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">地點</label>
                            <input type="text" id="editLocation" placeholder="例：A區田地" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">天氣</label>
                            <select id="editWeather" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                                <option value="">選擇天氣</option>
                                <option value="晴天">☀️ 晴天</option>
                                <option value="多雲">⛅ 多雲</option>
                                <option value="陰天">☁️ 陰天</option>
                                <option value="小雨">🌦️ 小雨</option>
                                <option value="大雨">🌧️ 大雨</option>
                            </select>
                        </div>
                    </div>

                    <!-- Work Details Row -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">作業類型</label>
                            <div class="relative">
                                <input type="text" id="editWorkType" placeholder="輸入或選擇作業類型..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all" onfocus="showEditWorkTypeSuggestions()" oninput="filterEditWorkTypeSuggestions()">
                                <div id="editWorkTypeSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-40 overflow-y-auto">
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectEditWorkType('整地')">🚜 整地</div>
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectEditWorkType('播種/育苗')">🌱 播種/育苗</div>
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectEditWorkType('施肥')">🌿 施肥</div>
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectEditWorkType('灌溉')">💧 灌溉</div>
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectEditWorkType('病蟲害防治')">🐛 病蟲害防治</div>
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectEditWorkType('除草')">🌾 除草</div>
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectEditWorkType('修剪/疏果')">✂️ 修剪/疏果</div>
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectEditWorkType('採收')">🥕 採收</div>
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectEditWorkType('維護')">🔧 維護</div>
                                    <div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" onclick="selectEditWorkType('其他')">📋 其他</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">作物</label>
                            <input type="text" id="editCrop" placeholder="例：番茄、玉米" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        </div>
                    </div>

                    <!-- Material Usage Section -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">🧪</span>資材使用
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700 mb-2">資材名稱</label>
                                <input type="text" id="editMaterialName" placeholder="輸入關鍵字搜尋資材..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                <div id="editMaterialSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-40 overflow-y-auto"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">使用量</label>
                                <input type="number" id="editMaterialQuantity" placeholder="數量" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">單位</label>
                                <select id="editMaterialUnit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                    <option value="毫升">毫升</option>
                                    <option value="公升">公升</option>
                                    <option value="克">克</option>
                                    <option value="公斤">公斤</option>
                                    <option value="斤">斤</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">稀釋倍數</label>
                                <input type="number" id="editDilutionRatio" placeholder="例：100" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 mb-4">
                            <button type="button" id="editAddMaterialBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                                <span class="mr-1">➕</span>添加資材
                            </button>
                        </div>
                        
                        <div id="editMaterialsList" class="space-y-2"></div>
                    </div>

                    <!-- Work Personnel Section -->
                    <div class="bg-gray-50 rounded-lg p-4 mt-6">
                        <h3 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
                            <span class="mr-2">👥</span>工作人員及工時
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700 mb-2">人員姓名</label>
                                <input type="text" id="editWorkerName" placeholder="輸入關鍵字搜尋人員..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                                <div id="editWorkerSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-40 overflow-y-auto"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">工作時數</label>
                                <input type="number" id="editWorkHours" placeholder="小時" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                            </div>
                            <div class="flex items-end">
                                <button type="button" id="editAddWorkerBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center w-full justify-center">
                                    <span class="mr-1">➕</span>添加人員
                                </button>
                            </div>
                        </div>
                        
                        <div id="editWorkersList" class="space-y-2"></div>
                    </div>

                    <!-- Details and Observations -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">作業詳情</label>
                            <textarea id="editDetails" rows="3" placeholder="詳細描述作業內容..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all resize-none"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">產量記錄</label>
                            <input type="text" id="editYield" placeholder="例：收穫 50 公斤番茄" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">觀察記錄</label>
                            <textarea id="editObservations" rows="3" placeholder="記錄作物生長狀況、病蟲害等..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all resize-none"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">備註</label>
                            <textarea id="editNotes" rows="3" placeholder="其他需要記錄的事項..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all resize-none"></textarea>
                        </div>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="flex justify-between">
                        <button type="button" onclick="deleteWorkLog()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center shadow-lg">
                            <span class="mr-2">🗑️</span>刪除記錄
                        </button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-medium transition-colors flex items-center shadow-lg">
                            <span class="mr-2">💾</span>更新記錄
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Material Details Modal -->
    <div id="materialDetailsModal" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="materialModalTitle" class="text-2xl font-bold text-gray-800"></h2>
                    <button onclick="closeMaterialModal()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                </div>
                
                <!-- Material Info -->
                <div id="materialInfo" class="bg-gray-50 rounded-lg p-4 mb-6"></div>
                
                <!-- Stock Adjustment -->
                <div class="bg-blue-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">庫存調整</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">調整類型</label>
                            <select id="adjustmentType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="入庫">入庫</option>
                                <option value="出庫">出庫</option>
                                <option value="調整">調整</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">數量</label>
                            <input type="number" id="adjustmentQuantity" placeholder="數量" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">單位</label>
                            <select id="adjustmentUnit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="毫升">毫升</option>
                                <option value="公升">公升</option>
                                <option value="克">克</option>
                                <option value="公斤">公斤</option>
                                <option value="斤">斤</option>
                                <option value="瓶">瓶</option>
                                <option value="包">包</option>
                                <option value="個">個</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">備註</label>
                            <input type="text" id="adjustmentNote" placeholder="調整原因" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex items-end">
                            <button onclick="adjustStock()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                確認調整
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Transaction History -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">進出記錄</h3>
                    <div id="transactionHistory" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let logEntries = [];
        let materials = [];
        let personnel = [];
        let currentMaterials = [];
        let currentWorkers = [];
        let currentDate = new Date();
        let currentMaterialId = null;
        let editingLogId = null;
        let editCurrentMaterials = [];
        let editCurrentWorkers = [];

        // Work type colors
        const WORK_TYPE_COLORS = {
            '整地': 'text-yellow-700 bg-yellow-50 border-yellow-200',
            '播種/育苗': 'text-blue-700 bg-blue-50 border-blue-200',
            '施肥': 'text-green-700 bg-green-50 border-green-200',
            '灌溉': 'text-indigo-700 bg-indigo-50 border-indigo-200',
            '病蟲害防治': 'text-red-700 bg-red-50 border-red-200',
            '除草': 'text-lime-700 bg-lime-50 border-lime-200',
            '修剪/疏果': 'text-pink-700 bg-pink-50 border-pink-200',
            '採收': 'text-purple-700 bg-purple-50 border-purple-200',
            '維護': 'text-gray-700 bg-gray-50 border-gray-200',
            '其他': 'text-zinc-700 bg-zinc-50 border-zinc-200',
        };

        // Work type short names for calendar display
        const WORK_TYPE_SHORT = {
            '整地': '整地',
            '播種/育苗': '播種',
            '施肥': '施肥',
            '灌溉': '灌溉',
            '病蟲害防治': '防治',
            '除草': '除草',
            '修剪/疏果': '修剪',
            '採收': '採收',
            '維護': '維護',
            '其他': '其他',
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateStats();
            setupEventListeners();
        });

        // Load data from localStorage
        function loadData() {
            try {
                logEntries = JSON.parse(localStorage.getItem('farmLogEntries') || '[]');
                materials = JSON.parse(localStorage.getItem('farmMaterials') || '[]');
                personnel = JSON.parse(localStorage.getItem('farmPersonnel') || '[]');
            } catch (error) {
                console.error('Error loading data:', error);
                logEntries = [];
                materials = [];
                personnel = [];
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('farmLogEntries', JSON.stringify(logEntries));
            localStorage.setItem('farmMaterials', JSON.stringify(materials));
            localStorage.setItem('farmPersonnel', JSON.stringify(personnel));
        }

        // Setup event listeners
        function setupEventListeners() {
            // Work log form
            const farmLogForm = document.getElementById('farmLogForm');
            if (farmLogForm) {
                farmLogForm.addEventListener('submit', handleWorkLogSubmit);
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                document.getElementById('addMaterialBtn').addEventListener('click', addMaterial);
                document.getElementById('addWorkerBtn').addEventListener('click', addWorker);
                
                // Material search
                document.getElementById('materialName').addEventListener('input', handleMaterialSearch);
                document.getElementById('materialName').addEventListener('blur', () => {
                    setTimeout(() => document.getElementById('materialSuggestions').classList.add('hidden'), 200);
                });
                
                // Worker search
                document.getElementById('workerName').addEventListener('input', handleWorkerSearch);
                document.getElementById('workerName').addEventListener('blur', () => {
                    setTimeout(() => document.getElementById('workerSuggestions').classList.add('hidden'), 200);
                });
                
                // Work type suggestions
                document.getElementById('workType').addEventListener('blur', () => {
                    setTimeout(() => document.getElementById('workTypeSuggestions').classList.add('hidden'), 200);
                });
                
                // Price calculation
                document.getElementById('initialStock').addEventListener('input', calculateUnitPrice);
            }

            // Edit work log form
            const editWorkLogForm = document.getElementById('editWorkLogForm');
            if (editWorkLogForm) {
                editWorkLogForm.addEventListener('submit', handleEditWorkLogSubmit);
                document.getElementById('editAddMaterialBtn').addEventListener('click', addEditMaterial);
                document.getElementById('editAddWorkerBtn').addEventListener('click', addEditWorker);
                
                // Edit material search
                document.getElementById('editMaterialName').addEventListener('input', handleEditMaterialSearch);
                document.getElementById('editMaterialName').addEventListener('blur', () => {
                    setTimeout(() => document.getElementById('editMaterialSuggestions').classList.add('hidden'), 200);
                });
                
                // Edit worker search
                document.getElementById('editWorkerName').addEventListener('input', handleEditWorkerSearch);
                document.getElementById('editWorkerName').addEventListener('blur', () => {
                    setTimeout(() => document.getElementById('editWorkerSuggestions').classList.add('hidden'), 200);
                });
                
                // Edit work type suggestions
                document.getElementById('editWorkType').addEventListener('blur', () => {
                    setTimeout(() => document.getElementById('editWorkTypeSuggestions').classList.add('hidden'), 200);
                });
            }

            // Add material form
            const addMaterialForm = document.getElementById('addMaterialForm');
            if (addMaterialForm) {
                addMaterialForm.addEventListener('submit', handleAddMaterial);
            }

            // Add personnel form
            const addPersonnelForm = document.getElementById('addPersonnelForm');
            if (addPersonnelForm) {
                addPersonnelForm.addEventListener('submit', handleAddPersonnel);
            }
        }

        // Show section
        function showSection(section) {
            // Hide all sections
            document.getElementById('coverPage').classList.add('hidden');
            document.getElementById('workLogSection').classList.add('hidden');
            document.getElementById('addResourcesSection').classList.add('hidden');
            document.getElementById('managementSection').classList.add('hidden');
            document.getElementById('allLogsSection').classList.add('hidden');

            // Show selected section
            if (section === 'cover') {
                document.getElementById('coverPage').classList.remove('hidden');
                updateStats();
            } else if (section === 'workLog') {
                document.getElementById('workLogSection').classList.remove('hidden');
                setupEventListeners();
            } else if (section === 'addResources') {
                document.getElementById('addResourcesSection').classList.remove('hidden');
                setupEventListeners();
            } else if (section === 'management') {
                document.getElementById('managementSection').classList.remove('hidden');
                displayMaterialsManagement();
                displayPersonnelManagement();
            } else if (section === 'allLogs') {
                document.getElementById('allLogsSection').classList.remove('hidden');
                displayCalendar();
            }
        }

        // Update statistics
        function updateStats() {
            document.getElementById('totalLogs').textContent = logEntries.length;
            document.getElementById('totalMaterials').textContent = materials.length;
            document.getElementById('totalPersonnel').textContent = personnel.length;
        }

        // Handle material search
        function handleMaterialSearch() {
            const query = document.getElementById('materialName').value.toLowerCase();
            const suggestions = document.getElementById('materialSuggestions');
            
            if (query.length < 1) {
                suggestions.classList.add('hidden');
                return;
            }
            
            const filteredMaterials = materials.filter(material => 
                material.name.toLowerCase().includes(query)
            );
            
            if (filteredMaterials.length === 0) {
                suggestions.classList.add('hidden');
                return;
            }
            
            suggestions.innerHTML = '';
            filteredMaterials.forEach(material => {
                const div = document.createElement('div');
                div.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0';
                div.innerHTML = `
                    <div class="font-medium">${material.name}</div>
                    <div class="text-sm text-gray-500">${material.category}</div>
                `;
                div.onclick = () => {
                    document.getElementById('materialName').value = material.name;
                    suggestions.classList.add('hidden');
                };
                suggestions.appendChild(div);
            });
            
            suggestions.classList.remove('hidden');
        }

        // Handle worker search
        function handleWorkerSearch() {
            const query = document.getElementById('workerName').value.toLowerCase();
            const suggestions = document.getElementById('workerSuggestions');
            
            if (query.length < 1) {
                suggestions.classList.add('hidden');
                return;
            }
            
            const filteredPersonnel = personnel.filter(person => 
                person.name.toLowerCase().includes(query)
            );
            
            if (filteredPersonnel.length === 0) {
                suggestions.classList.add('hidden');
                return;
            }
            
            suggestions.innerHTML = '';
            filteredPersonnel.forEach(person => {
                const div = document.createElement('div');
                div.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0';
                div.innerHTML = `
                    <div class="font-medium">${person.name}</div>
                    <div class="text-sm text-gray-500">${person.role}</div>
                `;
                div.onclick = () => {
                    document.getElementById('workerName').value = person.name;
                    suggestions.classList.add('hidden');
                };
                suggestions.appendChild(div);
            });
            
            suggestions.classList.remove('hidden');
        }

        // Add material to current list
        function addMaterial() {
            const name = document.getElementById('materialName').value.trim();
            const quantity = document.getElementById('materialQuantity').value;
            const unit = document.getElementById('materialUnit').value;
            const dilution = document.getElementById('dilutionRatio').value;
            
            if (!name || !quantity) {
                alert('請填寫資材名稱和使用量');
                return;
            }
            
            // Check if material exists and has enough stock
            const existingMaterial = materials.find(m => m.name === name);
            if (existingMaterial) {
                const actualUsage = convertToBaseUnit(parseFloat(quantity), unit, existingMaterial);
                if (actualUsage > existingMaterial.currentStock) {
                    alert(`庫存不足！${name} 目前庫存：${calculateStockDisplay(existingMaterial)}，需要：${quantity} ${unit}`);
                    return;
                }
            }
            
            const material = {
                name,
                quantity: parseFloat(quantity),
                unit,
                dilution: dilution ? parseFloat(dilution) : null
            };
            
            currentMaterials.push(material);
            displayCurrentMaterials();
            
            // Clear inputs
            document.getElementById('materialName').value = '';
            document.getElementById('materialQuantity').value = '';
            document.getElementById('dilutionRatio').value = '';
        }

        // Display current materials
        function displayCurrentMaterials() {
            const container = document.getElementById('materialsList');
            container.innerHTML = '';
            
            currentMaterials.forEach((material, index) => {
                const div = document.createElement('div');
                div.className = 'bg-white border border-gray-200 rounded-lg p-3 flex justify-between items-center';
                
                let dilutionText = material.dilution ? ` (稀釋 ${material.dilution} 倍)` : '';
                
                div.innerHTML = `
                    <span class="text-gray-800">
                        <strong>${material.name}</strong> - ${material.quantity} ${material.unit}${dilutionText}
                    </span>
                    <button onclick="removeCurrentMaterial(${index})" class="text-red-500 hover:text-red-700 transition-colors">
                        🗑️
                    </button>
                `;
                
                container.appendChild(div);
            });
        }

        // Remove current material
        function removeCurrentMaterial(index) {
            currentMaterials.splice(index, 1);
            displayCurrentMaterials();
        }

        // Add worker to current list
        function addWorker() {
            const name = document.getElementById('workerName').value.trim();
            const hours = document.getElementById('workHours').value;
            
            if (!name || !hours) {
                alert('請填寫人員姓名和工作時數');
                return;
            }
            
            const worker = {
                name,
                hours: parseFloat(hours)
            };
            
            currentWorkers.push(worker);
            displayCurrentWorkers();
            
            // Clear inputs
            document.getElementById('workerName').value = '';
            document.getElementById('workHours').value = '';
        }

        // Display current workers
        function displayCurrentWorkers() {
            const container = document.getElementById('workersList');
            container.innerHTML = '';
            
            currentWorkers.forEach((worker, index) => {
                const div = document.createElement('div');
                div.className = 'bg-white border border-gray-200 rounded-lg p-3 flex justify-between items-center';
                
                div.innerHTML = `
                    <span class="text-gray-800">
                        <strong>${worker.name}</strong> - ${worker.hours} 小時
                    </span>
                    <button onclick="removeCurrentWorker(${index})" class="text-red-500 hover:text-red-700 transition-colors">
                        🗑️
                    </button>
                `;
                
                container.appendChild(div);
            });
        }

        // Remove current worker
        function removeCurrentWorker(index) {
            currentWorkers.splice(index, 1);
            displayCurrentWorkers();
        }

        // Convert usage to base unit
        function convertToBaseUnit(quantity, fromUnit, material) {
            // If material has capacity info and we're using different units
            if (material.capacity && (material.stockUnit === '瓶' || material.stockUnit === '包')) {
                // Convert from capacity unit to stock unit (bottles/packages)
                if (fromUnit === material.capacity.unit) {
                    return quantity / material.capacity.amount;
                }
                // If using stock unit directly
                if (fromUnit === material.stockUnit) {
                    return quantity;
                }
            }
            
            // Direct unit conversion for non-packaged materials
            const conversions = {
                '毫升': { '公升': 0.001 },
                '公升': { '毫升': 1000 },
                '克': { '公斤': 0.001, '斤': 1/600 },
                '公斤': { '克': 1000, '斤': 0.6 },
                '斤': { '克': 600, '公斤': 1/0.6 }
            };
            
            if (conversions[fromUnit] && conversions[fromUnit][material.stockUnit]) {
                return quantity * conversions[fromUnit][material.stockUnit];
            }
            
            return quantity; // Same unit or no conversion available
        }

        // Calculate remaining stock display
        function calculateStockDisplay(material) {
            if (!material.capacity || (material.stockUnit !== '瓶' && material.stockUnit !== '包')) {
                return `${material.currentStock} ${material.stockUnit}`;
            }
            
            const wholeUnits = Math.floor(material.currentStock);
            const partialUnit = material.currentStock - wholeUnits;
            const partialAmount = partialUnit * material.capacity.amount;
            
            let display = `${wholeUnits} ${material.stockUnit}`;
            if (partialAmount > 0) {
                display += ` + ${partialAmount.toFixed(1)} ${material.capacity.unit}`;
            }
            
            return display;
        }

        // Handle work log form submission
        function handleWorkLogSubmit(e) {
            e.preventDefault();
            
            const formData = {
                id: Date.now(),
                date: document.getElementById('date').value,
                location: document.getElementById('location').value,
                weather: document.getElementById('weather').value,
                workType: document.getElementById('workType').value,
                crop: document.getElementById('crop').value,
                details: document.getElementById('details').value,
                yield: document.getElementById('yield').value,
                observations: document.getElementById('observations').value,
                notes: document.getElementById('notes').value,
                materials: [...currentMaterials],
                workers: [...currentWorkers],
                timestamp: new Date().toISOString()
            };
            
            if (!formData.date || !formData.workType) {
                alert('請填寫日期和作業類型');
                return;
            }
            
            // Process material usage and update stock
            let stockWarnings = [];
            for (let usedMaterial of currentMaterials) {
                const material = materials.find(m => m.name === usedMaterial.name);
                if (material) {
                    // Calculate actual usage amount
                    let actualUsage = usedMaterial.quantity;
                    
                    // Convert usage to base unit if needed
                    if (usedMaterial.unit !== material.stockUnit) {
                        actualUsage = convertToBaseUnit(usedMaterial.quantity, usedMaterial.unit, material);
                    }
                    
                    // Check if enough stock
                    if (actualUsage > material.currentStock) {
                        stockWarnings.push(`${material.name} 庫存不足！需要 ${actualUsage} ${material.stockUnit}，但只有 ${material.currentStock} ${material.stockUnit}`);
                        continue;
                    }
                    
                    // Update stock
                    material.currentStock -= actualUsage;
                    
                    // Add transaction record
                    if (!material.transactions) {
                        material.transactions = [];
                    }
                    
                    material.transactions.push({
                        id: Date.now() + Math.random(),
                        type: '出庫',
                        quantity: actualUsage,
                        originalQuantity: usedMaterial.quantity,
                        originalUnit: usedMaterial.unit,
                        dilution: usedMaterial.dilution,
                        date: new Date().toISOString(),
                        note: `工作日誌使用 - ${formData.workType} (${formData.date})`
                    });
                }
            }
            
            // Show warnings if any
            if (stockWarnings.length > 0) {
                alert('庫存警告：\n' + stockWarnings.join('\n'));
                return;
            }
            
            logEntries.unshift(formData);
            saveData();
            
            // Reset form
            document.getElementById('farmLogForm').reset();
            currentMaterials = [];
            currentWorkers = [];
            displayCurrentMaterials();
            displayCurrentWorkers();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            
            showNotification('工作日誌已成功儲存，庫存已更新！', 'success');
        }

        // Toggle capacity field
        function toggleCapacityField() {
            const unit = document.getElementById('stockUnit').value;
            const capacityField = document.getElementById('capacityField');
            const capacityLabel = document.getElementById('capacityLabel');
            
            if (unit === '瓶' || unit === '包') {
                capacityField.classList.remove('hidden');
                capacityLabel.textContent = unit === '瓶' ? '每瓶容量' : '每包容量';
            } else {
                capacityField.classList.add('hidden');
            }
            calculateUnitPrice();
        }

        // Calculate unit price
        function calculateUnitPrice() {
            const quantity = parseFloat(document.getElementById('initialStock').value) || 0;
            const price = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const unitPriceDisplay = document.getElementById('unitPriceDisplay');
            const unitPriceValue = document.getElementById('unitPriceValue');
            
            if (quantity > 0 && price > 0) {
                const unitPrice = (price / quantity).toFixed(2);
                unitPriceValue.textContent = unitPrice;
                unitPriceDisplay.classList.remove('hidden');
            } else {
                unitPriceDisplay.classList.add('hidden');
            }
        }

        // Show work type suggestions
        function showWorkTypeSuggestions() {
            document.getElementById('workTypeSuggestions').classList.remove('hidden');
        }

        // Filter work type suggestions
        function filterWorkTypeSuggestions() {
            const query = document.getElementById('workType').value.toLowerCase();
            const suggestions = document.getElementById('workTypeSuggestions').children;
            
            for (let suggestion of suggestions) {
                const text = suggestion.textContent.toLowerCase();
                if (text.includes(query)) {
                    suggestion.style.display = 'block';
                } else {
                    suggestion.style.display = 'none';
                }
            }
        }

        // Select work type
        function selectWorkType(type) {
            document.getElementById('workType').value = type;
            document.getElementById('workTypeSuggestions').classList.add('hidden');
        }

        // Handle add material form submission
        function handleAddMaterial(e) {
            e.preventDefault();
            
            const materialName = document.getElementById('newMaterialName').value.trim();
            const materialCategory = document.getElementById('materialCategory').value;
            const stockUnit = document.getElementById('stockUnit').value;
            const capacityAmount = document.getElementById('capacityAmount').value;
            const capacityUnit = document.getElementById('capacityUnit').value;
            const initialStock = parseFloat(document.getElementById('initialStock').value) || 0;
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const remarks = document.getElementById('materialRemarks').value;
            
            if (!materialName || !materialCategory) {
                alert('請填寫資材名稱和類別');
                return;
            }
            
            // Check if material already exists
            const existingMaterial = materials.find(m => m.name === materialName);
            
            if (existingMaterial) {
                // Material exists - add to existing stock
                existingMaterial.currentStock += initialStock;
                
                // Add transaction record
                if (initialStock > 0) {
                    if (!existingMaterial.transactions) {
                        existingMaterial.transactions = [];
                    }
                    
                    existingMaterial.transactions.push({
                        id: Date.now(),
                        type: '入庫',
                        quantity: initialStock,
                        date: new Date().toISOString(),
                        note: `補充庫存${purchasePrice > 0 ? ` - 入庫價 $${purchasePrice}` : ''}`
                    });
                }
                
                showNotification(`${materialName} 庫存已增加 ${initialStock} ${stockUnit}！`, 'success');
            } else {
                // New material - create new entry
                const material = {
                    id: Date.now(),
                    name: materialName,
                    category: materialCategory,
                    currentStock: initialStock,
                    stockUnit: stockUnit,
                    capacity: (stockUnit === '瓶' || stockUnit === '包') && capacityAmount ? {
                        amount: parseFloat(capacityAmount),
                        unit: capacityUnit
                    } : null,
                    purchasePrice: purchasePrice,
                    unitPrice: 0,
                    remarks: remarks,
                    transactions: []
                };
                
                // Calculate unit price
                if (material.currentStock > 0 && material.purchasePrice > 0) {
                    material.unitPrice = material.purchasePrice / material.currentStock;
                }
                
                // Add initial stock transaction
                if (material.currentStock > 0) {
                    material.transactions.push({
                        id: Date.now(),
                        type: '入庫',
                        quantity: material.currentStock,
                        date: new Date().toISOString(),
                        note: '初始庫存'
                    });
                }
                
                materials.push(material);
                showNotification('資材已成功新增！', 'success');
            }
            
            saveData();
            
            document.getElementById('addMaterialForm').reset();
            document.getElementById('capacityField').classList.add('hidden');
            document.getElementById('unitPriceDisplay').classList.add('hidden');
            
            // Refresh management display if we're on that page
            if (!document.getElementById('managementSection').classList.contains('hidden')) {
                displayMaterialsManagement();
            }
        }

        // Handle add personnel form submission
        function handleAddPersonnel(e) {
            e.preventDefault();
            
            const person = {
                id: Date.now(),
                name: document.getElementById('personnelName').value,
                role: document.getElementById('personnelRole').value,
                phone: document.getElementById('personnelPhone').value,
                skills: document.getElementById('personnelSkills').value
            };
            
            if (!person.name || !person.role) {
                alert('請填寫姓名和職位');
                return;
            }
            
            personnel.push(person);
            saveData();
            
            document.getElementById('addPersonnelForm').reset();
            showNotification('人員已成功新增！', 'success');
        }

        // Display materials management
        function displayMaterialsManagement() {
            const container = document.getElementById('managementMaterialsList');
            container.innerHTML = '';
            
            if (materials.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-6xl mb-4">🧪</div>
                        <h3 class="text-lg font-medium mb-2">尚無資材記錄</h3>
                        <p class="text-sm">請先到「新增資材及人員」頁面新增資材</p>
                    </div>
                `;
                return;
            }
            
            materials.forEach((material, index) => {
                const div = document.createElement('div');
                div.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer';
                
                let capacityInfo = '';
                if (material.capacity) {
                    capacityInfo = `<p class="text-sm text-gray-600">容量：${material.capacity.amount} ${material.capacity.unit}</p>`;
                }
                
                let priceInfo = '';
                if (material.purchasePrice > 0) {
                    priceInfo = `
                        <div class="flex items-center space-x-4 mt-2">
                            <span class="text-sm text-blue-600 bg-blue-50 px-2 py-1 rounded">
                                入庫價：$${material.purchasePrice}
                            </span>
                            ${material.unitPrice > 0 ? `<span class="text-sm text-purple-600 bg-purple-50 px-2 py-1 rounded">
                                單價：$${material.unitPrice.toFixed(2)}
                            </span>` : ''}
                        </div>
                    `;
                }
                
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1" onclick="showMaterialDetails(${material.id})">
                            <h4 class="font-medium text-gray-800 mb-2">${material.name}</h4>
                            <p class="text-sm text-gray-600">類別：${material.category}</p>
                            ${capacityInfo}
                            <div class="flex items-center space-x-4 mt-2">
                                <span class="text-sm text-green-600 bg-green-50 px-2 py-1 rounded">
                                    庫存：${calculateStockDisplay(material)}
                                </span>
                                ${material.currentStock <= 0 ? '<span class="text-sm text-red-600 bg-red-50 px-2 py-1 rounded">缺貨</span>' : ''}
                            </div>
                            ${priceInfo}
                            ${material.remarks ? `<p class="text-sm text-gray-500 mt-1">備註：${material.remarks}</p>` : ''}
                        </div>
                        <button onclick="deleteMaterial(${index})" class="text-red-500 hover:text-red-700 px-3 py-2 rounded hover:bg-red-50 transition-colors">
                            🗑️
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Display personnel management
        function displayPersonnelManagement() {
            const container = document.getElementById('personnelList');
            container.innerHTML = '';
            
            if (personnel.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-6xl mb-4">👥</div>
                        <h3 class="text-lg font-medium mb-2">尚無人員記錄</h3>
                        <p class="text-sm">請先到「新增資材及人員」頁面新增人員</p>
                    </div>
                `;
                return;
            }
            
            personnel.forEach((person, index) => {
                const div = document.createElement('div');
                div.className = 'border border-gray-200 rounded-lg p-4 flex justify-between items-center hover:shadow-md transition-shadow';
                div.innerHTML = `
                    <div>
                        <h4 class="font-medium text-gray-800">${person.name}</h4>
                        <p class="text-sm text-gray-600">職位：${person.role}</p>
                        ${person.phone ? `<p class="text-sm text-gray-600">電話：${person.phone}</p>` : ''}
                        ${person.skills ? `<p class="text-sm text-gray-600">專長：${person.skills}</p>` : ''}
                    </div>
                    <button onclick="deletePersonnel(${index})" class="text-red-500 hover:text-red-700 px-3 py-2 rounded hover:bg-red-50 transition-colors">
                        🗑️
                    </button>
                `;
                container.appendChild(div);
            });
        }

        // Delete material
        function deleteMaterial(index) {
            materials.splice(index, 1);
            saveData();
            displayMaterialsManagement();
            updateStats();
            showNotification('資材已刪除', 'info');
        }

        // Delete personnel
        function deletePersonnel(index) {
            personnel.splice(index, 1);
            saveData();
            displayPersonnelManagement();
            updateStats();
            showNotification('人員已刪除', 'info');
        }

        // Display calendar
        function displayCalendar() {
            const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', 
                              '七月', '八月', '九月', '十月', '十一月', '十二月'];
            
            document.getElementById('currentMonth').textContent = 
                `${currentDate.getFullYear()}年 ${monthNames[currentDate.getMonth()]}`;
            
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayDiv = document.createElement('div');
                dayDiv.className = `calendar-day border border-gray-200 p-2 cursor-pointer ${
                    date.getMonth() !== currentDate.getMonth() ? 'text-gray-400 bg-gray-50' : 'bg-white hover:bg-gray-50'
                }`;
                
                const dateStr = date.toISOString().split('T')[0];
                const dayLogs = logEntries.filter(log => log.date === dateStr);
                
                dayDiv.innerHTML = `
                    <div class="font-semibold text-lg mb-1" onclick="showDayDetails('${dateStr}')">${date.getDate()}</div>
                    <div class="space-y-1">
                        ${dayLogs.map(log => {
                            const workTypeColor = WORK_TYPE_COLORS[log.workType] || 'text-gray-700 bg-gray-50 border-gray-200';
                            const shortName = WORK_TYPE_SHORT[log.workType] || log.workType;
                            return `<div class="work-type-badge ${workTypeColor}" title="${log.workType}" onclick="event.stopPropagation(); editWorkLog(${log.id})">
                                        ${shortName}
                                    </div>`;
                        }).join('')}
                    </div>
                `;
                calendarDays.appendChild(dayDiv);
            }
        }

        // Change month
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            displayCalendar();
        }

        // Show day details
        function showDayDetails(dateStr) {
            const dayLogs = logEntries.filter(log => log.date === dateStr);
            const date = new Date(dateStr + 'T00:00:00');
            
            document.getElementById('modalDate').textContent = 
                `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日 工作記錄`;
            
            const dayLogsList = document.getElementById('dayLogsList');
            
            if (dayLogs.length === 0) {
                dayLogsList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">📝</div>
                        <p>這天沒有工作記錄</p>
                    </div>
                `;
            } else {
                dayLogsList.innerHTML = '';
                dayLogs.forEach(log => {
                    const logDiv = document.createElement('div');
                    logDiv.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow';
                    
                    const workTypeColor = WORK_TYPE_COLORS[log.workType] || 'text-gray-700 bg-gray-50 border-gray-200';
                    
                    let materialsHtml = '';
                    if (log.materials && log.materials.length > 0) {
                        materialsHtml = `
                            <div class="mt-3">
                                <h4 class="text-sm font-medium text-gray-700 mb-2">使用資材：</h4>
                                <div class="space-y-1">
                                    ${log.materials.map(material => {
                                        let dilutionText = material.dilution ? ` (稀釋 ${material.dilution} 倍)` : '';
                                        return `<div class="text-sm text-gray-600 bg-gray-50 px-2 py-1 rounded">
                                            ${material.name} - ${material.quantity} ${material.unit}${dilutionText}
                                        </div>`;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }

                    let workersHtml = '';
                    if (log.workers && log.workers.length > 0) {
                        const totalHours = log.workers.reduce((sum, worker) => sum + worker.hours, 0);
                        workersHtml = `
                            <div class="mt-3">
                                <h4 class="text-sm font-medium text-gray-700 mb-2">工作人員 (總計：${totalHours} 小時)：</h4>
                                <div class="space-y-1">
                                    ${log.workers.map(worker => {
                                        return `<div class="text-sm text-gray-600 bg-blue-50 px-2 py-1 rounded">
                                            ${worker.name} - ${worker.hours} 小時
                                        </div>`;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    logDiv.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center space-x-3">
                                <span class="px-3 py-1 rounded-full text-sm font-medium border ${workTypeColor}">
                                    ${log.workType}
                                </span>
                                ${log.weather ? `<span class="text-gray-500">${log.weather}</span>` : ''}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                ${log.location ? `<p class="text-sm text-gray-600 mb-1"><strong>地點：</strong>${log.location}</p>` : ''}
                                ${log.crop ? `<p class="text-sm text-gray-600 mb-1"><strong>作物：</strong>${log.crop}</p>` : ''}
                                ${log.details ? `<p class="text-sm text-gray-600 mb-1"><strong>作業詳情：</strong>${log.details}</p>` : ''}
                                ${log.yield ? `<p class="text-sm text-gray-600 mb-1"><strong>產量：</strong>${log.yield}</p>` : ''}
                            </div>
                            <div>
                                ${log.observations ? `<p class="text-sm text-gray-600 mb-1"><strong>觀察：</strong>${log.observations}</p>` : ''}
                                ${log.notes ? `<p class="text-sm text-gray-600 mb-1"><strong>備註：</strong>${log.notes}</p>` : ''}
                            </div>
                        </div>
                        
                        ${materialsHtml}
                        ${workersHtml}
                    `;
                    
                    dayLogsList.appendChild(logDiv);
                });
            }
            
            document.getElementById('dayDetailsModal').classList.remove('hidden');
        }

        // Close day modal
        function closeDayModal() {
            document.getElementById('dayDetailsModal').classList.add('hidden');
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-medium z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Export data
        function exportData() {
            const now = new Date();
            const dateStr = now.getFullYear() + 
                          String(now.getMonth() + 1).padStart(2, '0') + 
                          String(now.getDate()).padStart(2, '0');
            const timeStr = String(now.getHours()).padStart(2, '0') + 
                          String(now.getMinutes()).padStart(2, '0');

            // Export Work Logs CSV
            if (logEntries.length > 0) {
                const logsCsv = convertLogsToCSV(logEntries);
                downloadCSV(logsCsv, `工作日誌_${dateStr}_${timeStr}.csv`);
            }

            // Export Materials CSV
            if (materials.length > 0) {
                const materialsCsv = convertMaterialsToCSV(materials);
                downloadCSV(materialsCsv, `資材清單_${dateStr}_${timeStr}.csv`);
            }

            // Export Personnel CSV
            if (personnel.length > 0) {
                const personnelCsv = convertPersonnelToCSV(personnel);
                downloadCSV(personnelCsv, `人員清單_${dateStr}_${timeStr}.csv`);
            }

            showNotification(`已匯出 ${logEntries.length} 筆工作記錄、${materials.length} 項資材、${personnel.length} 位人員資料`, 'success');
        }

        // Convert logs to CSV
        function convertLogsToCSV(logs) {
            const headers = [
                '日期', '地點', '天氣', '作業類型', '作物', '作業詳情', '產量記錄', 
                '觀察記錄', '備註', '使用資材', '工作人員', '總工時'
            ];

            const csvRows = [headers.join(',')];

            logs.forEach(log => {
                const materialsText = log.materials ? log.materials.map(m => {
                    let dilution = m.dilution ? `(稀釋${m.dilution}倍)` : '';
                    return `${m.name}:${m.quantity}${m.unit}${dilution}`;
                }).join(';') : '';

                const workersText = log.workers ? log.workers.map(w => 
                    `${w.name}:${w.hours}小時`
                ).join(';') : '';

                const totalHours = log.workers ? log.workers.reduce((sum, w) => sum + w.hours, 0) : 0;

                const row = [
                    log.date || '',
                    escapeCSV(log.location || ''),
                    log.weather || '',
                    log.workType || '',
                    escapeCSV(log.crop || ''),
                    escapeCSV(log.details || ''),
                    escapeCSV(log.yield || ''),
                    escapeCSV(log.observations || ''),
                    escapeCSV(log.notes || ''),
                    escapeCSV(materialsText),
                    escapeCSV(workersText),
                    totalHours
                ];

                csvRows.push(row.join(','));
            });

            return csvRows.join('\n');
        }

        // Convert materials to CSV
        function convertMaterialsToCSV(materials) {
            const headers = ['資材名稱', '類別', '庫存數量', '庫存單位', '備註'];
            const csvRows = [headers.join(',')];

            materials.forEach(material => {
                const row = [
                    escapeCSV(material.name || ''),
                    escapeCSV(material.category || ''),
                    material.currentStock || 0,
                    escapeCSV(material.stockUnit || ''),
                    escapeCSV(material.remarks || '')
                ];
                csvRows.push(row.join(','));
            });

            return csvRows.join('\n');
        }

        // Convert personnel to CSV
        function convertPersonnelToCSV(personnel) {
            const headers = ['姓名', '職位', '聯絡電話', '專長'];
            const csvRows = [headers.join(',')];

            personnel.forEach(person => {
                const row = [
                    escapeCSV(person.name || ''),
                    escapeCSV(person.role || ''),
                    escapeCSV(person.phone || ''),
                    escapeCSV(person.skills || '')
                ];
                csvRows.push(row.join(','));
            });

            return csvRows.join('\n');
        }

        // Escape CSV
        function escapeCSV(text) {
            if (typeof text !== 'string') return text;
            if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                return '"' + text.replace(/"/g, '""') + '"';
            }
            return text;
        }

        // Download CSV
        function downloadCSV(csvContent, filename) {
            const BOM = '\uFEFF';
            const fullContent = BOM + csvContent;
            const blob = new Blob([fullContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Show material details
        function showMaterialDetails(materialId) {
            const material = materials.find(m => m.id === materialId);
            if (!material) return;
            
            currentMaterialId = materialId;
            
            // Set modal title
            document.getElementById('materialModalTitle').textContent = `${material.name} - 詳細資訊`;
            
            // Set adjustment unit to material's stock unit
            document.getElementById('adjustmentUnit').value = material.stockUnit;
            
            // Display material info
            const materialInfo = document.getElementById('materialInfo');
            let capacityInfo = '';
            if (material.capacity) {
                capacityInfo = `<p><strong>容量：</strong>${material.capacity.amount} ${material.capacity.unit}</p>`;
            }
            
            let priceInfo = '';
            if (material.purchasePrice > 0) {
                priceInfo = `
                    <p><strong>入庫價錢：</strong>$${material.purchasePrice}</p>
                    ${material.unitPrice > 0 ? `<p><strong>單位售價：</strong>$${material.unitPrice.toFixed(2)}</p>` : ''}
                `;
            }
            
            materialInfo.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p><strong>類別：</strong>${material.category}</p>
                        <p><strong>目前庫存：</strong>${calculateStockDisplay(material)}</p>
                        ${capacityInfo}
                    </div>
                    <div>
                        ${priceInfo}
                        ${material.remarks ? `<p><strong>備註：</strong>${material.remarks}</p>` : ''}
                    </div>
                </div>
            `;
            
            // Display transaction history
            displayTransactionHistory(material);
            
            // Show modal
            document.getElementById('materialDetailsModal').classList.remove('hidden');
        }

        // Display transaction history
        function displayTransactionHistory(material) {
            const container = document.getElementById('transactionHistory');
            container.innerHTML = '';
            
            if (!material.transactions || material.transactions.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <p>尚無進出記錄</p>
                    </div>
                `;
                return;
            }
            
            // Sort transactions by date (newest first)
            const sortedTransactions = [...material.transactions].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            sortedTransactions.forEach(transaction => {
                const div = document.createElement('div');
                const date = new Date(transaction.date);
                const dateStr = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                let typeColor = '';
                switch (transaction.type) {
                    case '入庫':
                        typeColor = 'text-green-700 bg-green-50 border-green-200';
                        break;
                    case '出庫':
                        typeColor = 'text-red-700 bg-red-50 border-red-200';
                        break;
                    case '調整':
                        typeColor = 'text-blue-700 bg-blue-50 border-blue-200';
                        break;
                }
                
                div.className = 'border border-gray-200 rounded-lg p-3 flex justify-between items-center';
                div.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-1">
                            <span class="px-2 py-1 rounded text-xs font-medium border ${typeColor}">
                                ${transaction.type}
                            </span>
                            <span class="text-sm text-gray-600">${dateStr}</span>
                        </div>
                        <div class="text-sm">
                            <span class="font-medium">數量：${transaction.quantity} ${material.stockUnit}</span>
                            ${transaction.originalQuantity && transaction.originalUnit && transaction.originalUnit !== material.stockUnit ? 
                                `<span class="text-gray-500 ml-2">(原始：${transaction.originalQuantity} ${transaction.originalUnit})</span>` : ''}
                            ${transaction.dilution ? `<span class="text-blue-500 ml-2">稀釋 ${transaction.dilution} 倍</span>` : ''}
                        </div>
                        ${transaction.note ? `<div class="text-sm text-gray-500 mt-1">備註：${transaction.note}</div>` : ''}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Adjust stock
        function adjustStock() {
            const type = document.getElementById('adjustmentType').value;
            const quantity = parseFloat(document.getElementById('adjustmentQuantity').value);
            const unit = document.getElementById('adjustmentUnit').value;
            const note = document.getElementById('adjustmentNote').value;
            
            if (!quantity || quantity <= 0) {
                alert('請輸入有效的數量');
                return;
            }
            
            const material = materials.find(m => m.id === currentMaterialId);
            if (!material) return;
            
            // Convert quantity to base unit if needed
            let actualQuantity = quantity;
            if (unit !== material.stockUnit) {
                actualQuantity = convertToBaseUnit(quantity, unit, material);
            }
            
            // Calculate new stock
            let newStock = material.currentStock;
            if (type === '入庫') {
                newStock += actualQuantity;
            } else if (type === '出庫') {
                newStock -= actualQuantity;
                if (newStock < 0) {
                    alert('庫存不足，無法出庫');
                    return;
                }
            } else if (type === '調整') {
                newStock = actualQuantity;
            }
            
            // Update material
            material.currentStock = newStock;
            
            // Add transaction record
            if (!material.transactions) {
                material.transactions = [];
            }
            
            material.transactions.push({
                id: Date.now(),
                type: type,
                quantity: actualQuantity,
                originalQuantity: quantity,
                originalUnit: unit,
                date: new Date().toISOString(),
                note: note || ''
            });
            
            // Save data
            saveData();
            
            // Update displays
            displayTransactionHistory(material);
            displayMaterialsManagement();
            updateStats();
            
            // Clear form
            document.getElementById('adjustmentQuantity').value = '';
            document.getElementById('adjustmentNote').value = '';
            
            showNotification(`庫存已${type}：${quantity} ${unit}`, 'success');
        }

        // Close material modal
        function closeMaterialModal() {
            document.getElementById('materialDetailsModal').classList.add('hidden');
            currentMaterialId = null;
        }

        // Edit work log
        function editWorkLog(logId) {
            const log = logEntries.find(l => l.id === logId);
            if (!log) return;
            
            editingLogId = logId;
            editCurrentMaterials = log.materials ? [...log.materials] : [];
            editCurrentWorkers = log.workers ? [...log.workers] : [];
            
            // Fill form with existing data
            document.getElementById('editDate').value = log.date || '';
            document.getElementById('editLocation').value = log.location || '';
            document.getElementById('editWeather').value = log.weather || '';
            document.getElementById('editWorkType').value = log.workType || '';
            document.getElementById('editCrop').value = log.crop || '';
            document.getElementById('editDetails').value = log.details || '';
            document.getElementById('editYield').value = log.yield || '';
            document.getElementById('editObservations').value = log.observations || '';
            document.getElementById('editNotes').value = log.notes || '';
            
            displayEditCurrentMaterials();
            displayEditCurrentWorkers();
            
            document.getElementById('editWorkLogModal').classList.remove('hidden');
        }

        // Handle edit material search
        function handleEditMaterialSearch() {
            const query = document.getElementById('editMaterialName').value.toLowerCase();
            const suggestions = document.getElementById('editMaterialSuggestions');
            
            if (query.length < 1) {
                suggestions.classList.add('hidden');
                return;
            }
            
            const filteredMaterials = materials.filter(material => 
                material.name.toLowerCase().includes(query)
            );
            
            if (filteredMaterials.length === 0) {
                suggestions.classList.add('hidden');
                return;
            }
            
            suggestions.innerHTML = '';
            filteredMaterials.forEach(material => {
                const div = document.createElement('div');
                div.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0';
                div.innerHTML = `
                    <div class="font-medium">${material.name}</div>
                    <div class="text-sm text-gray-500">${material.category}</div>
                `;
                div.onclick = () => {
                    document.getElementById('editMaterialName').value = material.name;
                    suggestions.classList.add('hidden');
                };
                suggestions.appendChild(div);
            });
            
            suggestions.classList.remove('hidden');
        }

        // Handle edit worker search
        function handleEditWorkerSearch() {
            const query = document.getElementById('editWorkerName').value.toLowerCase();
            const suggestions = document.getElementById('editWorkerSuggestions');
            
            if (query.length < 1) {
                suggestions.classList.add('hidden');
                return;
            }
            
            const filteredPersonnel = personnel.filter(person => 
                person.name.toLowerCase().includes(query)
            );
            
            if (filteredPersonnel.length === 0) {
                suggestions.classList.add('hidden');
                return;
            }
            
            suggestions.innerHTML = '';
            filteredPersonnel.forEach(person => {
                const div = document.createElement('div');
                div.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0';
                div.innerHTML = `
                    <div class="font-medium">${person.name}</div>
                    <div class="text-sm text-gray-500">${person.role}</div>
                `;
                div.onclick = () => {
                    document.getElementById('editWorkerName').value = person.name;
                    suggestions.classList.add('hidden');
                };
                suggestions.appendChild(div);
            });
            
            suggestions.classList.remove('hidden');
        }

        // Add edit material
        function addEditMaterial() {
            const name = document.getElementById('editMaterialName').value.trim();
            const quantity = document.getElementById('editMaterialQuantity').value;
            const unit = document.getElementById('editMaterialUnit').value;
            const dilution = document.getElementById('editDilutionRatio').value;
            
            if (!name || !quantity) {
                alert('請填寫資材名稱和使用量');
                return;
            }
            
            const material = {
                name,
                quantity: parseFloat(quantity),
                unit,
                dilution: dilution ? parseFloat(dilution) : null
            };
            
            editCurrentMaterials.push(material);
            displayEditCurrentMaterials();
            
            // Clear inputs
            document.getElementById('editMaterialName').value = '';
            document.getElementById('editMaterialQuantity').value = '';
            document.getElementById('editDilutionRatio').value = '';
        }

        // Display edit current materials
        function displayEditCurrentMaterials() {
            const container = document.getElementById('editMaterialsList');
            container.innerHTML = '';
            
            editCurrentMaterials.forEach((material, index) => {
                const div = document.createElement('div');
                div.className = 'bg-white border border-gray-200 rounded-lg p-3 flex justify-between items-center';
                
                let dilutionText = material.dilution ? ` (稀釋 ${material.dilution} 倍)` : '';
                
                div.innerHTML = `
                    <span class="text-gray-800">
                        <strong>${material.name}</strong> - ${material.quantity} ${material.unit}${dilutionText}
                    </span>
                    <button onclick="removeEditCurrentMaterial(${index})" class="text-red-500 hover:text-red-700 transition-colors">
                        🗑️
                    </button>
                `;
                
                container.appendChild(div);
            });
        }

        // Remove edit current material
        function removeEditCurrentMaterial(index) {
            editCurrentMaterials.splice(index, 1);
            displayEditCurrentMaterials();
        }

        // Add edit worker
        function addEditWorker() {
            const name = document.getElementById('editWorkerName').value.trim();
            const hours = document.getElementById('editWorkHours').value;
            
            if (!name || !hours) {
                alert('請填寫人員姓名和工作時數');
                return;
            }
            
            const worker = {
                name,
                hours: parseFloat(hours)
            };
            
            editCurrentWorkers.push(worker);
            displayEditCurrentWorkers();
            
            // Clear inputs
            document.getElementById('editWorkerName').value = '';
            document.getElementById('editWorkHours').value = '';
        }

        // Display edit current workers
        function displayEditCurrentWorkers() {
            const container = document.getElementById('editWorkersList');
            container.innerHTML = '';
            
            editCurrentWorkers.forEach((worker, index) => {
                const div = document.createElement('div');
                div.className = 'bg-white border border-gray-200 rounded-lg p-3 flex justify-between items-center';
                
                div.innerHTML = `
                    <span class="text-gray-800">
                        <strong>${worker.name}</strong> - ${worker.hours} 小時
                    </span>
                    <button onclick="removeEditCurrentWorker(${index})" class="text-red-500 hover:text-red-700 transition-colors">
                        🗑️
                    </button>
                `;
                
                container.appendChild(div);
            });
        }

        // Remove edit current worker
        function removeEditCurrentWorker(index) {
            editCurrentWorkers.splice(index, 1);
            displayEditCurrentWorkers();
        }

        // Show edit work type suggestions
        function showEditWorkTypeSuggestions() {
            document.getElementById('editWorkTypeSuggestions').classList.remove('hidden');
        }

        // Filter edit work type suggestions
        function filterEditWorkTypeSuggestions() {
            const query = document.getElementById('editWorkType').value.toLowerCase();
            const suggestions = document.getElementById('editWorkTypeSuggestions').children;
            
            for (let suggestion of suggestions) {
                const text = suggestion.textContent.toLowerCase();
                if (text.includes(query)) {
                    suggestion.style.display = 'block';
                } else {
                    suggestion.style.display = 'none';
                }
            }
        }

        // Select edit work type
        function selectEditWorkType(type) {
            document.getElementById('editWorkType').value = type;
            document.getElementById('editWorkTypeSuggestions').classList.add('hidden');
        }

        // Handle edit work log form submission
        function handleEditWorkLogSubmit(e) {
            e.preventDefault();
            
            const originalLog = logEntries.find(l => l.id === editingLogId);
            if (!originalLog) return;
            
            const updatedData = {
                id: editingLogId,
                date: document.getElementById('editDate').value,
                location: document.getElementById('editLocation').value,
                weather: document.getElementById('editWeather').value,
                workType: document.getElementById('editWorkType').value,
                crop: document.getElementById('editCrop').value,
                details: document.getElementById('editDetails').value,
                yield: document.getElementById('editYield').value,
                observations: document.getElementById('editObservations').value,
                notes: document.getElementById('editNotes').value,
                materials: [...editCurrentMaterials],
                workers: [...editCurrentWorkers],
                timestamp: originalLog.timestamp
            };
            
            if (!updatedData.date || !updatedData.workType) {
                alert('請填寫日期和作業類型');
                return;
            }
            
            // Restore original material usage to stock
            if (originalLog.materials) {
                originalLog.materials.forEach(usedMaterial => {
                    const material = materials.find(m => m.name === usedMaterial.name);
                    if (material) {
                        let actualUsage = usedMaterial.quantity;
                        if (usedMaterial.unit !== material.stockUnit) {
                            actualUsage = convertToBaseUnit(usedMaterial.quantity, usedMaterial.unit, material);
                        }
                        material.currentStock += actualUsage;
                        
                        // Remove old transaction
                        if (material.transactions) {
                            material.transactions = material.transactions.filter(t => 
                                !(t.note && t.note.includes(`工作日誌使用`) && t.note.includes(originalLog.date))
                            );
                        }
                    }
                });
            }
            
            // Apply new material usage
            let stockWarnings = [];
            for (let usedMaterial of editCurrentMaterials) {
                const material = materials.find(m => m.name === usedMaterial.name);
                if (material) {
                    let actualUsage = usedMaterial.quantity;
                    if (usedMaterial.unit !== material.stockUnit) {
                        actualUsage = convertToBaseUnit(usedMaterial.quantity, usedMaterial.unit, material);
                    }
                    
                    if (actualUsage > material.currentStock) {
                        stockWarnings.push(`${material.name} 庫存不足！需要 ${actualUsage} ${material.stockUnit}，但只有 ${material.currentStock} ${material.stockUnit}`);
                        continue;
                    }
                    
                    material.currentStock -= actualUsage;
                    
                    if (!material.transactions) {
                        material.transactions = [];
                    }
                    
                    material.transactions.push({
                        id: Date.now() + Math.random(),
                        type: '出庫',
                        quantity: actualUsage,
                        originalQuantity: usedMaterial.quantity,
                        originalUnit: usedMaterial.unit,
                        dilution: usedMaterial.dilution,
                        date: new Date().toISOString(),
                        note: `工作日誌使用 - ${updatedData.workType} (${updatedData.date})`
                    });
                }
            }
            
            if (stockWarnings.length > 0) {
                alert('庫存警告：\n' + stockWarnings.join('\n'));
                return;
            }
            
            // Update log entry
            const logIndex = logEntries.findIndex(l => l.id === editingLogId);
            if (logIndex !== -1) {
                logEntries[logIndex] = updatedData;
            }
            
            saveData();
            closeEditModal();
            displayCalendar();
            showNotification('工作日誌已成功更新！', 'success');
        }

        // Delete work log
        function deleteWorkLog() {
            if (!confirm('確定要刪除這筆工作記錄嗎？此操作無法復原。')) {
                return;
            }
            
            const originalLog = logEntries.find(l => l.id === editingLogId);
            if (!originalLog) return;
            
            // Restore material usage to stock
            if (originalLog.materials) {
                originalLog.materials.forEach(usedMaterial => {
                    const material = materials.find(m => m.name === usedMaterial.name);
                    if (material) {
                        let actualUsage = usedMaterial.quantity;
                        if (usedMaterial.unit !== material.stockUnit) {
                            actualUsage = convertToBaseUnit(usedMaterial.quantity, usedMaterial.unit, material);
                        }
                        material.currentStock += actualUsage;
                        
                        // Remove transaction
                        if (material.transactions) {
                            material.transactions = material.transactions.filter(t => 
                                !(t.note && t.note.includes(`工作日誌使用`) && t.note.includes(originalLog.date))
                            );
                        }
                    }
                });
            }
            
            // Remove log entry
            const logIndex = logEntries.findIndex(l => l.id === editingLogId);
            if (logIndex !== -1) {
                logEntries.splice(logIndex, 1);
            }
            
            saveData();
            closeEditModal();
            displayCalendar();
            updateStats();
            showNotification('工作記錄已刪除，庫存已恢復！', 'info');
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editWorkLogModal').classList.add('hidden');
            editingLogId = null;
            editCurrentMaterials = [];
            editCurrentWorkers = [];
        }

        // Import data
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showNotification('請選擇 CSV 格式的檔案', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    // Simple CSV parsing - in production, you'd want more robust parsing
                    const lines = csvContent.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        throw new Error('CSV檔案格式不正確');
                    }

                    showNotification('CSV匯入功能開發中...', 'info');
                } catch (error) {
                    showNotification('匯入失敗：' + error.message, 'error');
                }
            };

            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9661bb5e3693f220',t:'MTc1MzY3Nzk3Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
